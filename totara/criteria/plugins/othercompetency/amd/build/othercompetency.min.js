define(["core/templates","core/notification","core/ajax","totara_core/modal_list","totara_core/loader_manager","totara_competency/list_framework_hierarchy_events"],function(a,b,c,d,e,f){function g(){return this instanceof g?(this.widget="",this.loader=null,this.criterion={type:"othercompetency",aggregation:{},itemids:[]},this.criterionKey="",this.competencies=[],this.competencyAdder=null,this.endpoints={detail:"criteria_othercompetency_get_detail",competencies:"totara_competency_competency_index"},this.domClasses={hidden:"crit_hidden"},void(this.filename="othercompetency.js")):new g}g.prototype={events:function(){var a=this;this.widget.addEventListener("click",function(b){if(b.target)if(b.target.closest("[data-tw-criterionOtherCompetency-addCompetencies]"))b.preventDefault(),a.addCompetencies();else if(b.target.closest("[data-tw-criterionOtherCompetency-item-remove]")){b.preventDefault();var c,d=b.target.closest("[data-tw-criterionOtherCompetency-item-value]");if(!d)return;c=d.getAttribute("data-tw-criterionOtherCompetency-item-value"),a.removeCompetency(c)}}),this.widget.addEventListener("change",function(b){if(b.target)if(b.target.closest("[data-tw-criterionOtherCompetency-aggregationMethod-changed]")){b.preventDefault();var c=b.target.closest("[data-tw-criterionOtherCompetency-aggregationMethod-changed]").value;a.criterion.aggregation.method!=c&&(a.setAggregationMethod(c),a.triggerEvent("update",{criterion:a.criterion}),a.triggerEvent("dirty",{}))}else if(b.target.closest("[data-tw-criterionOtherCompetency-aggregationCount-changed]")){b.preventDefault();var d=b.target.closest("[data-tw-criterionOtherCompetency-aggregationCount-changed]").value;a.criterion.aggregation.reqitems!=d&&(a.setAggregationCount(d),a.triggerEvent("update",{criterion:a.criterion}),a.triggerEvent("dirty",{}))}})},setParent:function(a){this.widget=a},getDetail:function(){var a,d=this,e=this.widget.closest("[data-tw-criterion-key]"),f=0,g=0,h=null;return new Promise(function(i){e&&(f=e.hasAttribute("data-tw-criterion-key")?e.getAttribute("data-tw-criterion-key"):0,g=e.hasAttribute("data-tw-criterion-id")?e.getAttribute("data-tw-criterion-id"):0),0==g?h=new Promise(function(a){a(d.createEmptyCriterion())}):(a={args:{id:g},methodname:d.endpoints.detail},h=c.getData(a)),h.then(function(a){var b=a.results;d.criterion.id=g,d.criterionKey=f,d.setAggregationMethod(b.aggregation.method),d.setAggregationCount(b.aggregation.reqitems),Promise.all([d.setCompetencies(b.items),d.initCompetencyAdder()]).then(function(){d.triggerEvent("update",{criterion:d.criterion}),i()})})["catch"](function(a){a.fileName=d.filename,a.name="Error retrieving detail",b.exception(a)})})},setAggregationMethod:function(a){var b=this.widget.querySelector('[data-tw-criterionOtherCompetency-aggregationMethod="'+a+'"]'),c=b.querySelector("[data-tw-criterionOtherCompetency-aggregationMethod-changed]"),d=this.widget.querySelector("[data-tw-criterionOtherCompetency-aggregationCount-changed]"),e=b.querySelector("[data-tw-criterionOtherCompetency-aggregationCount-changed]");this.criterion.aggregation.method=a,c&&(c.checked=!0),d&&(d.disabled=!e)},setAggregationCount:function(a){var b=this.widget.querySelector("[data-tw-criterionOtherCompetency-aggregationCount-changed]");this.criterion.aggregation.reqitems=a,b&&(b.value=a)},setCompetencies:function(c){var d=this,e=this.widget.querySelector("[data-tw-criterionOtherCompetency-competencies]"),f=[],g={};return new Promise(function(h){if(d.competencies=[],d.criterion.itemids=[],0!=c.length&&e){for(var i=0;i<c.length;i++)d.competencies[c[i].id]=c[i],d.criterion.itemids.push(c[i].id),g={item_parent:"criterionOtherCompetency",value:c[i].id,text:c[i].name},f.push(a.renderAppend("totara_criteria/partial_item",g,e));Promise.all(f).then(function(){d.showHideNoCompetencies(),h()})["catch"](function(a){a.fileName=d.filename,a.name="Error showing competencies",b.exception(a)})}else d.showHideNoCompetencies(),h()})},createEmptyCriterion:function(){return new Promise(function(a){a({results:{id:0,items:[],aggregation:{method:1,reqitems:1}}})})},initCompetencyAdder:function(){var a=this;return new Promise(function(b){f.init().then(function(c){var e={key:"competencies",crumbtrail:{service:"totara_competency_competency_show",stringList:[{component:"criteria_othercompetency",key:"hierarchy_list:competency:all"},{component:"criteria_othercompetency",key:"hierarchy_list:competency:all_in_framework"}]},events:c,expandable:{args:{include:{crumbs:1}},service:"totara_competency_competency_show",template:"totara_competency/hierarchy_expanded"},levelToggle:!0,list:{map:{cols:[{dataPath:"fullname",expandedViewTrigger:!0,headerString:{component:"criteria_othercompetency",key:"selectcompetencies"}}],extraRowData:[{key:"framework",dataPath:"frameworkid"}],hasExpandedView:!0,hasHierarchy:!0},defaultFilters:{excluded_competency_id:document.querySelector("[data-comp-id]").getAttribute("data-comp-id")},service:"totara_competency_competency_index"},onSaved:function(b,c,d){a.updateCompetencies(d)},primaryDropDown:{filterKey:"framework",placeholderString:[{component:"criteria_othercompetency",key:"allframeworks"}],service:"totara_competency_get_frameworks",serviceArgs:{},serviceLabelKey:"fullname"},primarySearch:{filterKey:"text",placeholderString:[{component:"totara_core",key:"search"}]},title:[{component:"criteria_othercompetency",key:"hierarchy_list:competency:select"}]};d.adder(e).then(function(c){a.competencyAdder=c,b(c)})})})},addCompetencies:function(){var a=this;this.competencyAdder?this.competencyAdder.show(this.criterion.itemids):this.initCompetencyAdder().then(function(){a.competencyAdder.show(a.criterion.itemids)})["catch"](function(c){c.fileName=a.filename,c.name="Error initialsing the competency adder",b.exception(c)})},updateCompetencies:function(c){for(var d,e,f=this,g=f.widget.querySelector("[data-tw-criterionOtherCompetency-competencies]"),h=[],i={},j=0;j<c.length;j++)d=c[j].id,e=c[j].fullname,this.competencies[d]||(this.competencies[d]={id:d,name:e},this.criterion.itemids.push(d),i={item_parent:"criterionOtherCompetency",value:d,text:e},h.push(a.renderAppend("totara_criteria/partial_item",i,g)));h.length>0&&Promise.all(h).then(function(){f.showHideNoCompetencies(),f.triggerEvent("update",{criterion:f.criterion}),f.triggerEvent("dirty",{})})["catch"](function(a){a.fileName=f.filename,a.name="Showing competencies",b.exception(a)})},removeCompetency:function(a){a=parseInt(a);var b=this,c=b.widget.querySelector('[data-tw-criterionOtherCompetency-item-value="'+a+'"]'),d=this.criterion.itemids.indexOf(a);this.competencies[a]&&(delete this.competencies[a],d>=0&&this.criterion.itemids.splice(d,1),c&&c.remove()),b.showHideNoCompetencies(),b.triggerEvent("update",{criterion:b.criterion}),b.triggerEvent("dirty",{})},showHideNoCompetencies:function(){var a=this.widget.querySelector('[data-tw-criterionOtherCompetency-error="nocompetencies"]');a&&(this.criterion.itemids.length>0?a.classList.add(this.domClasses.hidden):a.classList.remove(this.domClasses.hidden))},triggerEvent:function(a,b){b.key=this.criterionKey;var c=new CustomEvent("totara_criteria/criterion:"+a,{bubbles:!0,detail:b});this.widget.dispatchEvent(c)}};var h=function(a){return new Promise(function(b){var c=new g;c.setParent(a),c.events(),c.loader=e.init(a),c.loader.show(),b(c),M.util.js_pending("criterionOtherCompetency"),c.getDetail().then(function(){c.loader.hide(),M.util.js_complete("criterionOtherCompetency")})})};return{init:h}});