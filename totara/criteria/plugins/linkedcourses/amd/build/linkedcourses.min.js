define(["core/ajax","core/notification","totara_core/loader_manager"],function(a,b,c){function d(){return this instanceof d?(this.widget="",this.loader=null,this.criterion={type:"linkedcourses",metadata:[],aggregation:{}},this.criterionKey="",this.linkedTypeKey="linkedtype",this.endpoints={detail:"criteria_linkedcourses_get_detail"},void(this.fileName="linkedcourses.js")):new d}d.prototype={events:function(){var a=this;this.widget.addEventListener("change",function(b){if(b.target)if(b.target.closest("[data-tw-criterionLinkedCourses-linkedType-changed]")){b.preventDefault();var c=b.target.closest("[data-tw-criterionLinkedCourses-linkedType-changed]").value;a.getLinkedType(a.criterion.metadata)!==c&&(a.setLinkedType(c),a.triggerEvent("update",{criterion:a.criterion}),a.triggerEvent("dirty",{}))}else if(b.target.closest("[data-tw-criterionLinkedCourses-aggregationMethod-changed]")){b.preventDefault();var d=b.target.closest("[data-tw-criterionLinkedCourses-aggregationMethod-changed]").value;a.criterion.aggregation.method!==d&&(a.setAggregationMethod(d),a.triggerEvent("update",{criterion:a.criterion}),a.triggerEvent("dirty",{}))}else if(b.target.closest("[data-tw-criterionLinkedCourses-aggregationCount-changed]")){b.preventDefault();var e=b.target.closest("[data-tw-criterionLinkedCourses-aggregationCount-changed]").value;a.criterion.aggregation.reqitems!=e&&(a.setAggregationCount(e),a.triggerEvent("update",{criterion:a.criterion}),a.triggerEvent("dirty",{}))}})},setParent:function(a){this.widget=a},getDetail:function(){var c,d,e=this,f=this.widget.closest("[data-tw-criterion-key]"),g=0,h=0;return new Promise(function(i){f&&(g=f.hasAttribute("data-tw-criterion-key")?f.getAttribute("data-tw-criterion-key"):0,h=f.hasAttribute("data-tw-criterion-id")?f.getAttribute("data-tw-criterion-id"):0),0==h?c=new Promise(function(a){a(e.createEmptyCriterion())}):(d={args:{id:h},methodname:e.endpoints.detail},c=a.getData(d)),c.then(function(a){var b=a.results;e.criterion.id=h,e.criterionKey=g,e.setLinkedType(e.getLinkedType(b.metadata)),e.setAggregationMethod(b.aggregation.method),e.setAggregationCount(b.aggregation.reqitems),e.triggerEvent("update",{criterion:e.criterion}),i()})["catch"](function(a){a.fileName=e.filename,a.name="Error retrieving detail",b.exception(a)})})},createEmptyCriterion:function(){var a=this;return new Promise(function(b){b({results:{id:0,metadata:[{metakey:a.linkedTypeKey,metavalue:"1"}],aggregation:{method:1,reqitems:1}}})})},getLinkedType:function(a){for(var b=0;b<a.length;b++)if(a[b].metakey==this.linkedTypeKey)return a[b].metavalue},setLinkedType:function(a){for(var b=this.widget.querySelector('[data-tw-criterionLinkedCourses-linkedType-changed="'+a+'"]'),c=!1,d=0;d<this.criterion.metadata.length;d++)if(this.criterion.metadata[d].metakey==this.linkedTypeKey){c=!0,this.criterion.metadata[d].metavalue=a;break}c||this.criterion.metadata.push({metakey:this.linkedTypeKey,metavalue:a}),b&&(b.checked=!0)},setAggregationMethod:function(a){var b=this.widget.querySelector('[data-tw-criterionLinkedCourses-aggregationMethod="'+a+'"]'),c=b.querySelector("[data-tw-criterionLinkedCourses-aggregationMethod-changed]"),d=this.widget.querySelector("[data-tw-criterionLinkedCourses-aggregationCount-changed]"),e=b.querySelector("[data-tw-criterionLinkedCourses-aggregationCount-changed]");this.criterion.aggregation.method=a,c&&(c.checked=!0),d&&(d.disabled=!e)},setAggregationCount:function(a){var b=this.widget.querySelector("[data-tw-criterionLinkedCourses-aggregationCount-changed]");this.criterion.aggregation.reqitems=a,b&&(b.value=a)},triggerEvent:function(a,b){b.key=this.criterionKey;var c=new CustomEvent("totara_criteria/criterion:"+a,{bubbles:!0,detail:b});this.widget.dispatchEvent(c)}};var e=function(a){return new Promise(function(b){var e=new d;e.setParent(a),e.events(),e.loader=c.init(a),e.loader.show(),b(e),M.util.js_pending("criterionLinkedCourses"),e.getDetail().then(function(){e.loader.hide(),M.util.js_complete("criterionLinkedCourses")})})};return{init:e}});