define(["core/templates","core/notification","core/ajax","totara_core/modal_list","totara_core/loader_manager"],function(a,b,c,d,e){function f(){return this instanceof f?(this.widget="",this.loader=null,this.criterion={type:"coursecompletion",itemids:[],aggregation:{}},this.courses=[],this.criterionKey="",this.courseAdder=null,this.endpoints={detail:"criteria_coursecompletion_get_detail",courses:"totara_competency_get_courses",courseCategories:"totara_competency_get_categories"},this.domClasses={hidden:"crit_hidden"},void(this.filename="coursecompletion.js")):new f}f.prototype={events:function(){var a=this;this.widget.addEventListener("click",function(b){if(b.target)if(b.target.closest("[data-tw-criterionCourseCompletion-addCourses]"))b.preventDefault(),a.addCourses();else if(b.target.closest("[data-tw-criterionCourseCompletion-item-remove]")){b.preventDefault();var c,d=b.target.closest("[data-tw-criterionCourseCompletion-item-value]");if(!d)return;c=d.getAttribute("data-tw-criterionCourseCompletion-item-value"),a.removeCourse(c)}}),this.widget.addEventListener("change",function(b){if(b.target)if(b.target.closest("[data-tw-criterionCourseCompletion-aggregationMethod-changed]")){b.preventDefault();var c=b.target.closest("[data-tw-criterionCourseCompletion-aggregationMethod-changed]").value;a.criterion.aggregation.method!=c&&(a.setAggregationMethod(c),a.triggerEvent("update",{criterion:a.criterion}),a.triggerEvent("dirty",{}))}else if(b.target.closest("[data-tw-criterionCourseCompletion-aggregationCount-changed]")){b.preventDefault();var d=b.target.closest("[data-tw-criterionCourseCompletion-aggregationCount-changed]").value;a.criterion.aggregation.reqitems!=d&&(a.setAggregationCount(d),a.triggerEvent("update",{criterion:a.criterion}),a.triggerEvent("dirty",{}))}})},setParent:function(a){this.widget=a},getDetail:function(){var a,d=this,e=this.widget.closest("[data-tw-criterion-key]"),f=0,g=0,h=null;return new Promise(function(i){e&&(f=e.hasAttribute("data-tw-criterion-key")?e.getAttribute("data-tw-criterion-key"):0,g=e.hasAttribute("data-tw-criterion-id")?e.getAttribute("data-tw-criterion-id"):0),0==g?h=new Promise(function(a){a(d.createEmptyCriterion())}):(a={args:{id:g},methodname:d.endpoints.detail},h=c.getData(a)),h.then(function(a){var b=a.results;d.criterion.id=g,d.criterionKey=f,d.setAggregationMethod(b.aggregation.method),d.setAggregationCount(b.aggregation.reqitems),Promise.all([d.setCourses(b.items),d.initCourseAdder()]).then(function(){d.triggerEvent("update",{criterion:d.criterion}),i()})})["catch"](function(a){a.fileName=d.filename,a.name="Error retrieving detail",b.exception(a)})})},setAggregationMethod:function(a){var b=this.widget.querySelector('[data-tw-criterionCourseCompletion-aggregationMethod="'+a+'"]'),c=b.querySelector("[data-tw-criterionCourseCompletion-aggregationMethod-changed]"),d=this.widget.querySelector("[data-tw-criterionCourseCompletion-aggregationCount-changed]"),e=b.querySelector("[data-tw-criterionCourseCompletion-aggregationCount-changed]");this.criterion.aggregation.method=a,c&&(c.checked=!0),d&&(d.disabled=!e)},setAggregationCount:function(a){var b=this.widget.querySelector("[data-tw-criterionCourseCompletion-aggregationCount-changed]");this.criterion.aggregation.reqitems=a,b&&(b.value=a)},setCourses:function(c){var d=this,e=this.widget.querySelector("[data-tw-criterionCourseCompletion-courses]"),f=[],g={};return new Promise(function(h){if(d.courses=[],d.criterion.itemids=[],0!=c.length&&e){for(var i=0;i<c.length;i++)d.courses[c[i].id]=c[i],d.criterion.itemids.push(c[i].id),g={item_parent:"criterionCourseCompletion",value:c[i].id,text:c[i].name},f.push(a.renderAppend("totara_criteria/partial_item",g,e));Promise.all(f).then(function(){d.showHideNoCourses(),h()})["catch"](function(a){a.fileName=d.filename,a.name="Error showing courses",b.exception(a)})}else d.showHideNoCourses(),h()})},createEmptyCriterion:function(){return new Promise(function(a){a({results:{id:0,items:[],aggregation:{method:1,reqitems:1}}})})},initCourseAdder:function(){var a=this;return new Promise(function(c){var e={key:"courseAdder_"+a.criterionKey,title:[{key:"selectcourses",component:"criteria_coursecompletion"}],list:{map:{cols:[{dataPath:"fullname",headerString:{key:"selectcourses",component:"totara_competency"}}]},service:a.endpoints.courses},primaryDropDown:{filterKey:"category",serviceLabelKey:"fullname",placeholderString:[{component:"totara_competency",key:"allcategories"}],service:a.endpoints.courseCategories,serviceArgs:{}},primarySearch:{filterKey:"name",placeholderString:[{component:"totara_competency",key:"searchcourses"}]},onSaved:function(b,c,d){a.updateCourses(d)}};d.adder(e).then(function(b){a.courseAdder=b,c(b)})["catch"](function(c){b.exception({fileName:a.filename,message:c[0]+" modal: "+c[1],name:"Error loading modal list adder"})})})},addCourses:function(){var a=this;this.courseAdder?this.courseAdder.show(this.criterion.itemids):this.initCourseAdder().then(function(){a.courseAdder.show(a.criterion.itemids)})["catch"](function(c){c.fileName=a.filename,c.name="Error initialsing the course adder",b.exception(c)})},updateCourses:function(c){for(var d,e,f=this,g=f.widget.querySelector("[data-tw-criterionCourseCompletion-courses]"),h=[],i={},j=0;j<c.length;j++)d=c[j].id,e=c[j].fullname,this.courses[d]||(this.courses[d]={id:d,name:e},this.criterion.itemids.push(d),i={item_parent:"criterionCourseCompletion",value:d,text:e},h.push(a.renderAppend("totara_criteria/partial_item",i,g)));h.length>0&&Promise.all(h).then(function(){f.showHideNoCourses(),f.triggerEvent("update",{criterion:f.criterion}),f.triggerEvent("dirty",{})})["catch"](function(a){a.fileName=f.filename,a.name="Showing courses",b.exception(a)})},removeCourse:function(a){a=parseInt(a);var b=this,c=b.widget.querySelector('[data-tw-criterionCourseCompletion-item-value="'+a+'"]'),d=this.criterion.itemids.indexOf(a);this.courses[a]&&(delete this.courses[a],d>=0&&this.criterion.itemids.splice(d,1),c&&c.remove()),b.showHideNoCourses(),b.triggerEvent("update",{criterion:b.criterion}),b.triggerEvent("dirty",{})},showHideNoCourses:function(){var a=this.widget.querySelector('[data-tw-criterionCourseCompletion-error="nocourses"]');a&&(this.criterion.itemids.length>0?a.classList.add(this.domClasses.hidden):a.classList.remove(this.domClasses.hidden))},triggerEvent:function(a,b){b.key=this.criterionKey;var c=new CustomEvent("totara_criteria/criterion:"+a,{bubbles:!0,detail:b});this.widget.dispatchEvent(c)}};var g=function(a){return new Promise(function(b){var c=new f;c.setParent(a),c.events(),c.loader=e.init(a),c.loader.show(),b(c),M.util.js_pending("criterionCourseCompletion"),c.getDetail().then(function(){c.loader.hide(),M.util.js_complete("criterionCourseCompletion")})})};return{init:g}});