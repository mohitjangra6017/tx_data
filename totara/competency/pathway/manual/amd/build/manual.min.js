define(["core/templates","core/notification","core/ajax","totara_competency/modal_list"],function(a,b,c,d){function e(){return this instanceof e?(this.widget="",this.pathway={id:0,sortorder:0,roles:[]},this.pwKey="",this.rolesPicker=null,this.fullRoles=[],this.roleIds=[],this.endpoints={create:"pathway_manual_create",update:"pathway_manual_update",detail:"pathway_manual_get_detail",allroles:"pathway_manual_get_roles"},void(this.filename="learning_plan.js")):new e}e.prototype={events:function(){var a=this;this.widget.addEventListener("click",function(b){if(b.target){if(b.target.closest("[data-pw-manual-action]")){var c=b.target.closest("[data-pw-manual-action]").getAttribute("data-pw-manual-action");"addraters"===c&&a.pickRaters()}if(b.target.closest("[data-pw-item-remove]")&&b.target.closest("[data-pw-item-value]")){var d=b.target.closest("[data-pw-item-value]").getAttribute("data-pw-item-value");a.removeRole(d)}}})},setParent:function(a){this.widget=a},initData:function(d){var e,f,g=this,h=this.widget.closest("[data-pw-key]"),i=0,j=0,k=this.widget.closest("[data-pw-id]");h&&(i=h.getAttribute("data-pw-key")?h.getAttribute("data-pw-key"):0),k&&(j=k.getAttribute("data-pw-id")?k.getAttribute("data-pw-id"):0),0!==j?(e={args:{id:j},methodname:this.endpoints.detail},f=c.getData(e)):f=g.createEmptyPw(),f.then(function(c){var e,f=c.results;if(g.pwKey=i,e=d,0===j){var h=document.querySelector("[data-comp-id]"),k=1;h&&(k=h.getAttribute("data-comp-id")?h.getAttribute("data-comp-id"):1),g.pathway.competency_id=k,delete g.pathway.id,e.setAttribute("data-pw-save-endpoint",g.endpoints.create)}else g.pathway.id=j,e.setAttribute("data-pw-save-endpoint",g.endpoints.update);var l=f.roles,m=[];e=d.querySelector(".pw_roles"),g.pathway.roles=[],g.roleIds=[];for(var n=0;n<f.roles.length;n++)g.pathway.roles.push(f.roles[n].role),g.roleIds.push(f.roles[n].id),g.fullRoles[f.roles[n].id]=f.roles[n],m.push(a.renderAppend("totara_competency/partial_item",{value:l[n].id,text:l[n].name},e));g.showHideNoRaters(),m.push(g.initRolesPicker()),Promise.all(m).then(function(){g.triggerEvent("update",{pathway:g.pathway})})["catch"](function(a){b.exception({fileName:g.filename,message:a[0]+" modal: "+a[1],name:"Error initialising manual data"})})})["catch"](function(a){a.fileName=g.filename,a.name="Error retrieving manual detail",b.exception(a)})},initRolesPicker:function(){var a=this;return new Promise(function(c){var e={key:"pwManualRolesPicker_"+a.pwKey,title:[{key:"selectraters",component:"pathway_manual"}],list:{map:{cols:[{dataPath:"name",headerString:{key:"selectraters",component:"pathway_manual"}}]},service:a.endpoints.allroles},onSaved:function(b,c,d){a.updateRoles(d)}};d.adder(e).then(function(b){a.rolesPicker=b,c(b)})["catch"](function(c){b.exception({fileName:a.filename,message:c[0]+" modal: "+c[1],name:"Error loading modal list adder"})})})},pickRaters:function(){var a=this;this.rolesPicker?a.rolesPicker.show(a.roleIds):this.initRolesPicker().then(function(b){b.show(a.roleIds)})["catch"](function(c){b.exception({fileName:a.filename,message:c[0]+" modal: "+c[1],name:"Error loading modal list adder"})})},updateRoles:function(c){for(var d=this,e=this.widget.querySelector(".pw_roles"),f=[],g={},h=0;h<c.length;h++){var i=c[h];this.roleIds.indexOf(i.id)<0&&(this.pathway.roles.push(i.role),this.roleIds.push(i.id),this.fullRoles[i.id]=i,g={value:i.id,text:i.name},f.push(a.renderAppend("totara_competency/partial_item",g,e)))}d.showHideNoRaters(),f.length>0&&Promise.all(f).then(function(){d.triggerEvent("update",{pathway:d.pathway}),d.triggerEvent("dirty",{})})["catch"](function(a){a.fileName=d.filename,a.name="Error showing updated roles",b.exception(a)})},removeRole:function(a){a=parseInt(a);var b,c=this.roleIds.indexOf(a),d=-1;c>=0&&(this.fullRoles[a]&&(d=this.pathway.roles.indexOf(this.fullRoles[a].role),delete this.fullRoles[a]),d>=0&&this.pathway.roles.splice(d,1),this.roleIds.splice(c,1),b=this.widget.querySelector('.pw_item[data-pw-item-value="'+a+'"'),b&&(b.remove(),this.triggerEvent("update",{pathway:this.pathway}),this.triggerEvent("dirty",{}))),this.showHideNoRaters()},createEmptyPw:function(){return new Promise(function(a){a({results:{roles:[]}})})},showHideNoRaters:function(){var a=this.widget.querySelector(".pw_manual_error_noraters");0==this.roleIds.length?a.classList.remove("cc_hidden"):a.classList.add("cc_hidden")},triggerEvent:function(a,b){b.key=this.pwKey;var c=new CustomEvent("totara_competency/pathway:"+a,{bubbles:!0,detail:b});this.widget.dispatchEvent(c)}};var f=function(a){return new Promise(function(b){var c=new e;c.setParent(a),c.events(),c.initData(a),b(c)})};return{init:f}});