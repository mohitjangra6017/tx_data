define(["core/str","core/notification","core/templates","core/ajax"],function(a,b,c,d){function e(){return this instanceof e?(this.widget="",this.pathway={id:0,criteria:[]},this.pwKey="",this.lastCritKey=0,this.criteria={},this.markedForDeletionCriteria={},this.typeModal=null,this.endpoints={criteria:"pathway_criteria_group_get_criteria",criteriatemplate:"totara_criteria_get_definition_template",create:"pathway_criteria_group_create",update:"pathway_criteria_group_update","delete":"pathway_criteria_group_delete"},void(this.filename="criteria_group.js")):new e}e.prototype={events:function(){var a=this;this.widget.addEventListener("click",function(c){if(!c.target)return!1;if(c.target.closest("[data-cg-action]")){var d=c.target.closest("[data-cg-action]").getAttribute("data-cg-action");"addcrit"===d&&a.showCriteriaTypeOptions()}else if(c.target.closest("[data-criteria_group-crit-type-option]")){var e=c.target.closest("[data-criteria_group-crit-type-option]").getAttribute("data-criteria_group-crit-type-option");a.hideCritTypeSelectors(),a.addCriterion(a.pwKey,e)}else if(c.target.closest("[data-crit-action]")){var f,g=c.target.closest("[data-crit-action]"),d=g.getAttribute("data-crit-action"),h=g.closest("[data-tw-criterion-key]");if(!h)return void b.exception({fileName:a.filename,message:"Can't determine target of the "+d+" criterion action",name:"No criterion action target"});a.hideCritTypeSelectors(),f=h.getAttribute("data-tw-criterion-key"),"toggle-detail"===d?a.toggleCriterionDetail(f):"remove"===d?a.removeCriterion(f):"undo"===d&&a.undoCriterionRemoval(f)}return!1})},bubbledEventsListener:function(){var a=this,b="totara_criteria/criterion:";this.widget.addEventListener(b+"update",function(b){var c=b.detail.key,d=b.detail.criterion;d&&(a.criteria[c]||(a.criteria[c]={},a.markedForDeletionCriteria[c]&&delete a.markedForDeletionCriteria[c]),a.criteria[c].detail=d),a.packCriteria(),a.triggerEvent("update",{pathway:a.pathway}),a.showHideNoCriteria()}),this.widget.addEventListener(b+"dirty",function(b){var c=b.detail.key;a.criteria[c]&&(a.criteria[c].dirty=!0,a.triggerEvent("dirty",{}))})},setParent:function(a){this.widget=a},initData:function(){var a,e=this,f=this.widget.closest("[data-pw-key]"),g=0,h=0,i=this.widget.closest("[data-pw-id]");if(f&&(g=f.getAttribute("data-pw-key")?f.getAttribute("data-pw-key"):0),!i){var j=document.querySelector("[data-comp-id]"),k=1,l=this.widget.closest("[data-pw-scalevalue]"),m=this.widget.hasAttribute("data-pw-init-criterion")?this.widget.getAttribute("data-pw-init-criterion"):"",n=1;return j&&(k=j.getAttribute("data-comp-id")?j.getAttribute("data-comp-id"):1),l&&(n=l.getAttribute("data-pw-scalevalue")?l.getAttribute("data-pw-scalevalue"):1),e.pathway=e.createEmptyPw(k,n),e.pwKey=g,e.widget.setAttribute("data-pw-save-endpoint",this.endpoints.create),m?e.addCriterion(g,m):(e.showHideNoCriteria(),void e.triggerEvent("update",{pathway:e.pathway}))}return h=i.getAttribute("data-pw-id")?i.getAttribute("data-pw-id"):0,a={args:{id:h},methodname:this.endpoints.criteria},d.getData(a).then(function(a){var d=a.results,f=e.widget.querySelector(".critgrp_criteria"),i=[];e.criteria=[],e.pathway.criteria=[],e.pwKey=g,e.pathway.id=h;for(var j=0;j<d.length;j++){var k=d[j];k.key=e.getNextCritKey(),k.expanded=!1,k.singleuse?(k.expandable=!1,k.showand=!1,e.hideBottomActions()):(k.expandable=!0,k.showand=j>0),e.criteria[k.key]=k,i.push(k)}c.renderAppend("pathway_criteria_group/partial_group_criteria",{criteria:i},f).then(function(){c.runTemplateJS(""),e.showHideNoCriteria()})["catch"](function(a){a.fileName=e.filename,a.name="Error showing criteria detail",b.exception(a)})})["catch"](function(a){a.fileName=e.filename,a.name="Error getting criteria",b.exception(a)}),!1},getNextCritKey:function(){return this.lastCritKey++,this.pwKey+"_crit_"+this.lastCritKey},packCriteria:function(){this.pathway.criteria=[];for(var a in this.criteria)this.criteria[a].detail&&this.pathway.criteria.push(this.criteria[a].detail)},showHideNoCriteria:function(){var a=this.pathway.criteria.length,b=0;return this.markedForDeletionCriteria.some(function(a){return void 0!==a})&&(b+=1),a+b==0?this.widget.querySelector(".critgrp_criteria_none").classList.remove("cc_hidden"):this.widget.querySelector(".critgrp_criteria_none").classList.add("cc_hidden"),!1},hideBottomActions:function(){var a=this.widget.closest("[data-pw-key]").querySelector(".critgrp_bottom_action");return a.classList.add("cc_hidden"),!1},showBottomActions:function(){var a=this.widget.closest("[data-pw-key]").querySelector(".critgrp_bottom_action");return a.classList.remove("cc_hidden"),!1},createEmptyPw:function(a,b){return{comp_id:a,scalevalue:b,criteria:[]}},hideCritTypeSelectors:function(){for(var a=document.querySelectorAll("[data-crit-type-toggle]"),b=0;b<a.length;b++)a[b].classList.add("cc_hidden");return!1},showCriteriaTypeOptions:function(){var a=this.widget.querySelector('[data-crit-type-toggle="criteria_group"]'),b=!!a&&!a.classList.contains("cc_hidden");return this.hideCritTypeSelectors(),a&&!b&&a.classList.remove("cc_hidden"),!1},addCriterion:function(a,e){var f=this,g={args:{type:e},methodname:this.endpoints.criteriatemplate},h=this.widget.querySelector(".critgrp_criteria");return d.getData(g).then(function(a){var b="pathway_criteria_group/partial_criterion",d=a.results;d.key=f.getNextCritKey(),d.singleuse?(d.expandable=!1,d.showand=!1,f.hideBottomActions(),f.triggerEvent("singleuse",{used:!0})):(d.expandable=!0,d.showand=f.pathway.criteria.length>0),f.toggleSingleUse(!1),f.criteria[d.key]=d,c.renderAppend(b,d,h).then(function(){c.runTemplateJS(""),f.triggerEvent("dirty",{})},function(a){alert(a)})})["catch"](function(a){a.fileName=f.filename,a.name="Error getting criteria template",b.exception(a)}),!1},toggleSingleUse:function(a){var b=this.widget.querySelectorAll("[data-crit-type-singleuse-active]"),c=this.widget.querySelectorAll("[data-crit-type-singleuse-disabled]");if(b.length>0)if(a){for(var d=0;d<b.length;d++)b[d].classList.remove("cc_hidden");for(var d=0;d<c.length;d++)c[d].classList.add("cc_hidden")}else{for(var d=0;d<b.length;d++)b[d].classList.add("cc_hidden");for(var d=0;d<c.length;d++)c[d].classList.remove("cc_hidden")}return!1},toggleAllSingleUse:function(a){for(var b,c,d,e,f,g=document.querySelectorAll('[data-crit-type-toggle="criteria_group"]'),h=0;h<g.length;h++)if(f=a,b=g[h].querySelectorAll("[data-crit-type-singleuse-active]"),c=g[h].querySelectorAll("[data-crit-type-singleuse-disabled]"),0!=b.length)if(a&&(d=g[h].closest("[data-pw-key]"),d&&(e=d.querySelectorAll("[data-criterion-active]"),e.length>0&&(f=!1))),f){for(var i=0;i<b.length;i++)b[i].classList.remove("cc_hidden");for(var i=0;i<c.length;i++)c[i].classList.add("cc_hidden")}else{for(var i=0;i<b.length;i++)b[i].classList.add("cc_hidden");for(var i=0;i<c.length;i++)c[i].classList.remove("cc_hidden")}return!1},toggleCriterionDetail:function(a){var b=this.widget.querySelector('[data-tw-criterion-key="'+a+'"]'),c=this.widget.querySelector('[data-crit-detail="'+a+'"]'),d=b.hasAttribute("data-crit-detail-expanded")?b.getAttribute("data-crit-detail-expanded"):0,e=b.querySelector('[data-crit-detail-icon="expanded"]'),f=b.querySelector('[data-crit-detail-icon="collapsed"]');return 1==d?(c.classList.add("cc_hidden"),e.classList.add("cc_hidden"),f.classList.remove("cc_hidden"),b.removeAttribute("data-crit-detail-expanded")):(c.classList.remove("cc_hidden"),e.classList.remove("cc_hidden"),f.classList.add("cc_hidden"),b.setAttribute("data-crit-detail-expanded","1")),!1},removeCriterion:function(a){var b,d=this,e=this.widget.querySelector('[data-tw-criterion-key="'+a+'"]'),f=this.widget.querySelector('[data-pw-and="'+a+'"]');if(this.criteria[a].singleuse&&(this.toggleAllSingleUse(!0),this.triggerEvent("singleuse",{used:!1}),this.showBottomActions()),this.criteria[a])if(this.criteria[a].id&&0!=this.criteria[a].id){var g=e.querySelector("[data-criterion-detail]"),h={};b=this.criteria[a],b.deleted=!0,h[a]=this.criteria[a],Object.assign(this.markedForDeletionCriteria,h),delete this.criteria[a],this.packCriteria(),c.renderReplace("pathway_criteria_group/partial_criterion_detail",b,g).then(function(){var a=e.querySelector('[data-crit-action="remove"]'),b=e.querySelector('[data-crit-action="undo"]');a.classList.add("cc_hidden"),b.classList.remove("cc_hidden"),d.triggerEvent("update",{pathway:d.pathway}),d.triggerEvent("dirty",{})})}else e&&e.remove(),f?f.remove():this.pathway.criteria.length>1&&(f=this.widget.querySelector("[data-pw-and]"),f&&f.remove()),delete this.criteria[a],this.packCriteria(),0==this.pathway.criteria.length?this.triggerEvent("remove",{}):this.triggerEvent("update",{pathway:this.pathway}),this.triggerEvent("dirty",{});return!1},undoCriterionRemoval:function(d){if(this.markedForDeletionCriteria[d]){var e,f=this,g=this.widget.querySelector('[data-tw-criterion-key="'+d+'"]'),h=g.querySelector("[data-criterion-detail]"),i={};if(this.markedForDeletionCriteria[d].singleuse){var j=document.querySelector("[data-singleuse]"),k="0";if(j&&(k=j.getAttribute("data-singleuse")),"1"==k)return b.clearNotifications(),void a.get_string("error:cant_undo_singleuse","pathway_criteria_group").done(function(a){b.addNotification({message:a,type:"error"}),window.scrollTo(0,0)}).fail(b.exception)}return i[d]=this.markedForDeletionCriteria[d],Object.assign(this.criteria,i),delete this.markedForDeletionCriteria[d],this.packCriteria(),this.criteria[d].singleuse?(this.triggerEvent("singleuse",{used:!0}),this.toggleAllSingleUse(!1)):this.toggleSingleUse(!1),e=this.criteria[d],e.deleted=!1,c.renderReplace("pathway_criteria_group/partial_criterion_detail",e,h).then(function(){var a=g.querySelector('[data-crit-action="remove"]'),b=g.querySelector('[data-crit-action="undo"]');b.classList.add("cc_hidden"),a.classList.remove("cc_hidden"),f.triggerEvent("update",{pathway:f.pathway}),f.triggerEvent("dirty",{})}),!1}},triggerEvent:function(a,b){b.key=this.pwKey;var c=new CustomEvent("totara_competency/pathway:"+a,{bubbles:!0,detail:b});this.widget.dispatchEvent(c)}};var f=function(a){return new Promise(function(b){var c=new e;c.setParent(a),c.events(),c.bubbledEventsListener(),c.initData(),b(c)})};return{init:f}});