define(["core/templates","core/ajax","core/modal_factory","core/modal_events","core/notification","core/str"],function(a,b,c,d,e,f){function g(){return this instanceof g?(this.widget="",this.comp_id="",this.scale_id="",this.pathways=[],this.scalevalues=[],this.markedForDeletionPathways=[],this.nPaths=0,this.nDeletedPaths=0,this.singlevalShown=!1,this.critTypes=[],this.lastKey=0,this.aggType="",this.aggFunction="",this.dirty=!1,this.endpoints={competencyScale:"totara_competency_get_scale",scalevalues:"totara_competency_get_scale_values",criteriaTypes:"pathway_criteria_group_get_criteria_types",pathways:"totara_competency_get_pathways",pathwaySummary:"totara_competency_get_summary_template",definitionTemplate:"totara_competency_get_definition_template",defaultpreset:"totara_competency_link_default_preset",deletePathways:"totara_competency_delete_pathways",overallAggregation:"totara_competency_set_overall_aggregation"},void(this.filename="achievement_paths.js")):new g}g.prototype={events:function(){var a=this;this.widget.addEventListener("click",function(b){if(b.target)if(b.target.closest("[data-cc-action]")){var c=b.target.closest("[data-cc-action]"),d=c.getAttribute("data-cc-action");"linkdefaultpreset"===d?a.linkDefaultPreset():"applychanges"===d?a.applyChanges():"cancelchanges"===d&&a.cancelChanges()}else if(b.target.closest("[data-scalevalue-action")){var d=b.target.closest("[data-scalevalue-action]").getAttribute("data-scalevalue-action"),e=b.target.closest("[data-scalevalue-id]");"add-pw"===d&&a.showCriteriaTypeOptions(e)}else if(b.target.closest("[data-scalevalue-crit-type-option]")){var f=b.target.closest("[data-scalevalue-crit-type-option]").getAttribute("data-scalevalue-crit-type-option");e=b.target.closest("[data-scalevalue-id]"),a.addSinglevaluePath(e,"criteria_group",f)}else if(b.target.closest("[data-pw-action")){var c=b.target.closest("[data-pw-action]"),d=c.getAttribute("data-pw-action"),g=b.target.closest("[data-pw-key]").getAttribute("data-pw-key");"remove"===d?a.removePathway(g):"undo"===d&&a.undoRemovePathway(g)}else if(b.target.closest("[data-cc-agg-action")){var d=b.target.closest("[data-cc-agg-action]").getAttribute("data-cc-agg-action");"edit"===d?a.disableOrdering():"move"===d&&a.enableOrdering()}}),this.widget.addEventListener("change",function(b){if(b.target)if(b.target.closest("[data-cc-add-pathway]")){var c=b.target.closest("[data-cc-add-pathway]").querySelector("option:checked").value;a.addPath(c)}else if(b.target.closest("[data-cc-pw-agg-changed]")){var d=b.target.closest("[data-cc-pw-agg-changed]");d.querySelector("option:checked"),a.widget.querySelector("[data-cc-pw-agg-actions]");a.setOverallAggregation(),a.dirty=!0}}),this.widget.addEventListener("dragstart",function(a){if(a.target.closest("[data-cc-orderable]")){var b=a.target.closest("[data-cc-orderable]"),c=b.getAttribute("data-cc-orderable");a.dataTransfer.setData("orderKey",c)}}),this.widget.addEventListener("dragover",function(a){a.preventDefault()}),this.widget.addEventListener("drop",function(b){if(b.preventDefault(),b.target.closest("[data-cc-orderable]")){var c=b.dataTransfer.getData("orderKey"),d=a.widget.querySelector('[data-cc-orderable="'+c+'"]'),e=b.target.closest("[data-cc-orderable]");e.parentNode.insertBefore(d,e.nextSibling)}}),window.addEventListener("beforeunload",function(b){if(a.dirty)return b.preventDefault(),b.returnValue="",""})},bubbledEventsListener:function(){var a=this,b="totara_competency/pathway:";this.widget.addEventListener(b+"dirty",function(b){var c=b.detail.key;a.pathways[c]&&(a.pathways[c].dirty=!0),a.dirty=!0}),this.widget.addEventListener(b+"update",function(b){var c=b.detail.key,d=b.detail.pathway;a.pathways[c]||(a.pathways[c]={},a.nPaths+=1,a.showHideNoPaths()),a.pathways[c].detail=d}),this.widget.addEventListener(b+"remove",function(b){var c=b.detail.key;a.removePathway(c)}),this.widget.addEventListener(b+"singleuse",function(b){var c=b.detail.used;a.widget.setAttribute("data-singleuse",c?"1":"0"),a.toggleSingleUseCritTypes(!c)})},setParent:function(a){this.widget=a},showNotification:function(a,b,c,d){"undefined"==typeof d&&(d={}),e.clearNotifications(),f.get_string(b,c,d).done(function(b){e.addNotification({message:b,type:a}),window.scrollTo(0,0)}).fail(e.exception)},initData:function(){var a=this;this.widget.hasAttribute("data-comp-id")&&(this.comp_id=this.widget.getAttribute("data-comp-id")),this.setOverallAggregation(),this.setScale().then(function(){a.updatePage()})},getNextKey:function(){return this.lastKey++,"pw_"+this.lastKey},updatePage:function(){if(this.comp_id&&0!=this.scalevalues.length){var c,d=this,f=[];this.getCriteriaTypes().then(function(){c={args:{comp_id:d.comp_id},methodname:d.endpoints.pathways},b.getData(c).then(function(b){var c=b.results;d.clearPathways(),d.nPaths=c.length,d.singlevalShown=!1;for(var g=0;g<c.length;g++){var h=c[g];if(!h.pathway_templatename)return void e.exception({fileName:d.filename,message:"Templatename for pathway "+h.title+" ("+h.id+") is missing",name:"Pathway without templatename"});if(h.key=d.getNextKey(),d.pathways[h.key]=h,h.scalevalue)d.singlevalShown=!0,d.scalevalues[h.scalevalue].pathways.push(h.key);else{var i;i=d.singlevalShown?d.widget.querySelector('[data-pw-multivalues="high-sortorder"]'):d.widget.querySelector('[data-pw-multivalues="low-sortorder"]');var j="totara_competency/partial_pathway";h.outerborder=!0,h.actions=!0,h.orderable=!0,f.push(a.renderAppend(j,h,i))}}f.push(d.showSinglevaluePaths()),Promise.all(f).then(function(b){d.calculateSortorderFromDisplay(),d.dirty=!1,a.runTemplateJS(""),d.showHideNoPaths()})["catch"](function(a){a.fileName=d.filename,a.name="Error displaying pathways",e.exception(a)})})["catch"](function(a){a.fileName=d.filename,a.name="Error retrieving pathways",e.exception(a)})})["catch"](function(a){a.fileName=d.filename,a.name="Error retrieving criteria types",e.exception(a)})}},setScale:function(){var a=this;return new Promise(function(c,d){if(!a.scale_id&&a.widget.hasAttribute("data-scale-id")&&(a.scale_id=a.widget.getAttribute("data-scale-id")),a.scale_id)a.setScaleValues().then(function(a){c()});else{a.comp_id||d("Competency or scale id is required");var f={args:{comp_id:a.comp_id},methodname:a.endpoints.competencyScale};b.getData(f).then(function(b){a.scale_id=b.results,a.setScaleValues().then(function(a){c()})["catch"](function(b){b.fileName=a.filename,b.name="Error setting scalevalues",e.exception(b)})})["catch"](function(b){b.fileName=a.filename,b.name="Error retrieving scale",e.exception(b)})}})},setScaleValues:function(){var a=this;return new Promise(function(c,d){a.scale_id||d("Scale id not set");var f={args:{scale_id:a.scale_id},methodname:a.endpoints.scalevalues};b.getData(f).then(function(b){a.scalevalues=[];for(var d=0;d<b.results.length;d++){var e=b.results[d];e.pathways=[],a.scalevalues[e.id]=e}c()})["catch"](function(b){b.fileName=a.filename,b.name="Error retrieving scalevalues",e.exception(b)})})},clearPathways:function(){this.pathways=[],this.nPaths=0;for(var a in this.scalevalues)this.scalevalues[a].pathways=[];for(var b=this.widget.querySelectorAll("[data-pw-multivalues]"),c=0;c<b.length;c++)b[c].innerHTML="";b=this.widget.querySelectorAll("[data-pw-singlevalues]");for(var c=0;c<b.length;c++)b[c].innerHTML="";this.markedForDeletionPathways=[],this.nDeletedPaths=0},showSinglevaluePaths:function(){var b=this.widget.querySelector("[data-pw-singlevalues]"),c="totara_competency/scalevalue_pathways_edit",d={scalevalues:[]};for(var e in this.scalevalues){for(var f=this.scalevalues[e],g={id:f.id,name:f.name,proficient:f.proficient,criteriaTypes:this.critTypes,critTypeLevel:"scalevalue",pathways:[]},h=0;h<f.pathways.length;h++)this.pathways[f.pathways[h]].showor=h>0,this.pathways[f.pathways[h]].orderable=!1,this.pathways[f.pathways[h]].critTypeLevel=this.pathways[f.pathways[h]].type,g.pathways.push(this.pathways[f.pathways[h]]);d.scalevalues.push(g)}return a.renderReplace(c,d,b)},addPath:function(c){if("0"!=c){if("singlevalue"===c)return this.singlevalShown=!0,void this.showHideNoPaths();var d,f=this,g={args:{type:c},methodname:this.endpoints.definitionTemplate};b.getData(g).then(function(b){var g=f.getNextKey(),h="totara_competency/partial_pathway",i=b.results;i.key=g,i.outerborder=!0,i.actions=!0,i.orderable=!0,f.pathways[g]=i,f.nPaths+=1,d=f.singlevalShown?f.widget.querySelector('[data-pw-multivalues="high-sortorder"]'):f.widget.querySelector('[data-pw-multivalues="low-sortorder"]'),a.renderAppend(h,f.pathways[g],d).then(function(){f.calculateSortorderFromDisplay(),f.dirty=!0,f.showHideNoPaths(),a.runTemplateJS("")})["catch"](function(a){a.fileName=f.filename,a.name="Error displayin "+c,e.exception(a)})})["catch"](function(a){a.fileName=f.filename,a.name="Error retrieving definition template for "+c,e.exception(a)})}},hideCritTypeSelectors:function(){for(var a=this.widget.querySelectorAll("[data-crit-type-toggle]"),b=0;b<a.length;b++)a[b].classList.add("cc_hidden")},showCriteriaTypeOptions:function(a){var b=a.querySelector('[data-crit-type-toggle="scalevalue"]'),c=!!b&&!b.classList.contains("cc_hidden");this.hideCritTypeSelectors(),b&&!c&&b.classList.remove("cc_hidden")},addSinglevaluePath:function(c,d,f){var g=this,h=c.getAttribute("data-scalevalue-id"),i={args:{type:d},methodname:this.endpoints.definitionTemplate},j=c.querySelector("[data-cc-scalevalue-pw-list]");b.getData(i).then(function(b){var c=g.getNextKey(),i="totara_competency/partial_pathway",k=b.results;k.key=c,k.scalevalue=h,k.outerborder=!1,k.showor=g.scalevalues[k.scalevalue].pathways.length>0,k.critType=f,k.criteriaTypes=g.critTypes,k.critTypeLevel=d,g.pathways[c]=k,g.scalevalues[h].pathways.push(c),g.nPaths+=1,a.renderAppend(i,g.pathways[c],j).then(function(){g.hideCritTypeSelectors(),g.calculateSortorderFromDisplay(),g.dirty=!0,a.runTemplateJS("")})["catch"](function(a){a.fileName=g.filename,a.name="Error displaying template for "+d,e.exception(a)})})["catch"](function(a){a.fileName=g.filename,a.name="Error retrieving definition template for "+d,e.exception(a)})},applyChanges:function(){var a,c,d,f,g=this,h=this.widget.querySelectorAll("[data-pw-save-endpoint]"),i=[];if(this.dirty){for(var j=Math.round(Date.now()/1e3),k=0;k<h.length;k++)a=h[k].getAttribute("data-pw-save-endpoint"),c=h[k].getAttribute("data-pw-save-req-sortorder"),d=h[k].closest("[data-pw-key]").getAttribute("data-pw-key"),this.pathways[d]&&this.pathways[d].dirty&&this.pathways[d].detail&&(f={args:this.pathways[d].detail,methodname:a},f.args.actiontime=j,c&&(f.args.sortorder=this.pathways[d].sortorder),i.push(b.getData(f)));if(this.nDeletedPaths>0){var l=[];for(d in this.markedForDeletionPathways)l.push({type:this.markedForDeletionPathways[d].type,id:this.markedForDeletionPathways[d].id});f={args:{comp_id:this.comp_id,pathways:l,actiontime:j},methodname:this.endpoints.deletePathways},i.push(b.getData(f))}f={args:{comp_id:this.comp_id,type:this.aggType,actiontime:j},methodname:this.endpoints.overallAggregation},i.push(b.getData(f)),i.length>0&&Promise.all(i).then(function(a){g.showNotification("success","applysuccess","totara_competency",{}),g.dirty=!1,g.updatePage()})["catch"](function(a){a.fileName=g.filename,a.name="Error applying changes",e.exception(a)})}},showHideNoPaths:function(){var a=this.widget.querySelector("[data-cc-pw-aggregation]"),b=this.widget.querySelector(".pw_none"),c=this.widget.querySelector("[data-pw-singlevalues]"),d=this.widget.querySelector('[name="cc_add_pathway_select"] option[value="singlevalue"]'),e=this.widget.querySelector('[data-cc-action="linkdefaultpreset"]');0!=this.nPaths||this.singlevalShown?(a&&a.classList.remove("cc_hidden"),b&&b.classList.add("cc_hidden"),e&&e.classList.add("cc_hidden")):(a&&a.classList.add("cc_hidden"),b&&b.classList.remove("cc_hidden"),e&&e.classList.remove("cc_hidden")),this.singlevalShown?(c&&c.classList.remove("cc_hidden"),d&&(d.disabled=!0)):(c&&c.classList.add("cc_hidden"),d&&(d.disabled=!1))},calculateSortorderFromDisplay:function(){for(var a,b,c=this.widget.querySelectorAll("[data-pw-key]"),d=0,e=0;e<c.length;e++)a=c[e].getAttribute("data-pw-key"),this.pathways[a]?b=this.pathways[a]:this.markedForDeletionPathways[a]&&(b=this.markedForDeletionPathways[a]),b.sortorder!=d+1&&(this.pathways[a].dirty=!0,this.dirty=!0),b.sortorder=++d,c[e].setAttribute("data-pw-sortorder",b.sortorder)},linkDefaultPreset:function(){var a=this,c={args:{comp_id:this.comp_id},methodname:this.endpoints.defaultpreset};b.getData(c).then(function(b){a.updatePage()})["catch"](function(b){b.fileName=a.filename,b.name="Error linking default preset pathways",e.exception(b)})},cancelChanges:function(){if(this.widget.querySelector("[data-cc-cancel-href]")){var a=this.widget.querySelector("[data-cc-cancel-href]").getAttribute("data-cc-cancel-href");window.location.href=a}},removePathway:function(a){var b=this.widget.querySelector('[data-pw-key="'+a+'"]'),c=this.widget.querySelector('[data-pw-or="'+a+'"]');if(this.pathways[a])if(this.dirty=!0,this.pathways[a].id&&0!=this.pathways[a].id){var d=(b.querySelector("[data-pathway-detail]"),{});d[a]=this.pathways[a],Object.assign(this.markedForDeletionPathways,d),this.nDeletedPaths+=1,delete this.pathways[a];for(var e,f=b.querySelectorAll("[data-pw-on-delete]"),g=0;g<f.length;g++)e=f[g].getAttribute("data-pw-on-delete"),"mark"==e?f[g].classList.add("cc_deleted"):"hide"==e&&f[g].classList.add("cc_hidden");var h=b.querySelector('[data-pw-action="remove"]'),i=b.querySelector('[data-pw-action="undo"]');h.classList.add("cc_hidden"),i.classList.remove("cc_hidden")}else{if(this.pathways[a].scalevalue){var j=this.pathways[a].scalevalue,k=this.scalevalues[j].pathways.indexOf(a);if(k>=0&&this.scalevalues[j].pathways.splice(k,1),c)c.remove();else if(this.scalevalues[j].pathways.length>0){var l=this.widget.querySelector('[data-scalevalue-id="'+j+'"]');l&&(c=l.querySelector("[data-pw-or]"),c&&c.remove())}}delete this.pathways[a],this.nPaths-=1,this.showHideNoPaths(),b&&b.remove(),this.dirty=!0}},undoRemovePathway:function(a){var b=this.widget.querySelector('[data-pw-key="'+a+'"]'),c=(b.querySelector("[data-pathway-detail]"),{});if(this.markedForDeletionPathways[a]){c[a]=this.markedForDeletionPathways[a],Object.assign(this.pathways,c),delete this.markedForDeletionPathways[a],this.nDeletedPaths-=1;for(var d,e=b.querySelectorAll("[data-pw-on-delete]"),f=0;f<e.length;f++)d=e[f].getAttribute("data-pw-on-delete"),"mark"==d?e[f].classList.remove("cc_deleted"):"hide"==d&&e[f].classList.remove("cc_hidden");var g=b.querySelector('[data-pw-action="remove"]'),h=b.querySelector('[data-pw-action="undo"]');g.classList.remove("cc_hidden"),h.classList.add("cc_hidden")}},getCriteriaTypes:function(){var a=this,c=this.widget.hasAttribute("data-singleuse")?this.widget.getAttribute("data-singleuse"):"0";return new Promise(function(d,f){if(a.critTypes&&a.critTypes.length>0)d();else{var g={args:{},methodname:a.endpoints.criteriaTypes};b.getData(g).then(function(b){var e=b.results;a.critTypes=[];for(var f=0;f<e.length;f++)e[f].disabled=e[f].singleuse&&"1"==c,a.critTypes.push(e[f]);d()})["catch"](function(b){b.fileName=a.filename,b.name="Error getting criteria types",e.exception(b)})}})},toggleSingleUseCritTypes:function(a){for(var b,c,d,e,f,g,h=this.widget.querySelectorAll('[data-crit-type-toggle="scalevalue"]'),i=0;i<h.length;i++)if(d=h[i].closest("[data-scalevalue-id]"),e=null,d&&(e=d.getAttribute("data-scalevalue-id")),e&&(b=h[i].querySelectorAll("[data-crit-type-singleuse-active]"),c=h[i].querySelectorAll("[data-crit-type-singleuse-disabled]"),0!=b.length)){if(f=a)for(g=this.scalevalues[e].pathways,j=0;j<g.length;j++)if(this.pathways[g[j]]){f=!1;break}if(f){for(var j=0;j<b.length;j++)b[j].classList.remove("cc_hidden");for(var j=0;j<c.length;j++)c[j].classList.add("cc_hidden")}else{for(var j=0;j<b.length;j++)b[j].classList.add("cc_hidden");for(var j=0;j<c.length;j++)c[j].classList.remove("cc_hidden")}}},setOverallAggregation:function(){var a=this.widget.querySelector("[data-cc-pw-agg-changed]"),b=a.querySelector("option:checked"),c=this.widget.querySelector("[data-cc-pw-agg-actions]");this.aggType=b.value,b.hasAttribute("data-cc-pw-agg-function")?(this.aggFunction=b.getAttribute("data-cc-pw-agg-function"),c&&c.classList.remove("cc_hidden")):(this.aggFunction="",c&&c.classList.add("cc_hidden"))},enableOrdering:function(){for(var a,b=this.widget.querySelector('[data-cc-agg-action="edit"]'),c=this.widget.querySelector('[data-cc-agg-action="move"]'),d=this.widget.querySelectorAll("[data-cc-orderable]"),e=this.widget.querySelectorAll("[data-cc-on-ordering]"),f=0;f<d.length;f++)d[f].classList.add("cc_order_border"),d[f].draggable=!0;for(var f=0;f<e.length;f++)a=e[f].getAttribute("data-cc-on-ordering"),"hide"==a?e[f].classList.add("cc_hidden"):"show"==a?e[f].classList.remove("cc_hidden"):"disable"==a&&(e[f].disabled=!0);b&&(b.disabled=!1),c&&(c.disabled=!0)},disableOrdering:function(){for(var a,b=this.widget.querySelector('[data-cc-agg-action="edit"]'),c=this.widget.querySelector('[data-cc-agg-action="move"]'),d=this.widget.querySelectorAll("[data-cc-orderable]"),e=this.widget.querySelectorAll("[data-cc-on-ordering]"),f=0;f<d.length;f++)d[f].classList.remove("cc_order_border"),d[f].draggable=!1;for(var f=0;f<e.length;f++)a=e[f].getAttribute("data-cc-on-ordering"),"hide"==a?e[f].classList.remove("cc_hidden"):"show"==a?e[f].classList.add("cc_hidden"):"disable"==a&&(e[f].disabled=!1);b&&(b.disabled=!0),c&&(c.disabled=!1),this.aggFunction&&"function"==typeof this[this.aggFunction]&&this[this.aggFunction]()}};var h=function(a){return new Promise(function(b){var c=new g;c.setParent(a),c.events(),c.bubbledEventsListener(),c.initData(),b(c)})};return{init:h}});