define(["core/templates","core/ajax","core/modal_factory","core/modal_events","core/notification","core/str"],function(a,b,c,d,e,f){function g(){return this instanceof g?(this.widget="",this.competency_id="",this.scale_id="",this.pathways=[],this.markedForDeletionPathways=[],this.nPaths=0,this.nDeletedPaths=0,this.singlevalShown=!1,this.criteriaTypes=[],this.lastKey=0,this.aggType="",this.aggFunction="",this.dirty=!1,this.endpoints={criteriaTypes:"pathway_criteria_group_get_criteria_types",pathways:"totara_competency_get_pathways",deletePathways:"totara_competency_delete_pathways",setOverallAggregation:"totara_competency_set_overall_aggregation"},void(this.filename="achievement_paths.js")):new g}g.prototype={events:function(){var a=this;this.widget.addEventListener("click",function(b){if(b.target)if(b.target.closest("[data-cc-action]")){var c=b.target.closest("[data-cc-action]"),d=c.getAttribute("data-cc-action");"applychanges"===d?a.applyChanges():"cancelchanges"===d&&a.cancelChanges()}else if(b.target.closest("[data-scalevalue-action")){var d=b.target.closest("[data-scalevalue-action]").getAttribute("data-scalevalue-action"),e=b.target.closest("[data-scalevalue-id]");"add-pw"===d&&a.showCriteriaTypeOptions(e)}else if(b.target.closest("[data-scalevalue-criterion-type]")){var f=b.target.closest("[data-scalevalue-criterion-type]");e=b.target.closest("[data-scalevalue-id]"),a.addSinglevaluePath(e,f)}else if(b.target.closest("[data-pw-action")){var c=b.target.closest("[data-pw-action]"),d=c.getAttribute("data-pw-action"),g=b.target.closest("[data-pw-key]").getAttribute("data-pw-key");"remove"===d?a.removePathway(g):"undo"===d&&a.undoRemovePathway(g)}else if(b.target.closest("[data-cc-agg-action")){var d=b.target.closest("[data-cc-agg-action]").getAttribute("data-cc-agg-action");"edit"===d?a.disableOrdering():"move"===d&&a.enableOrdering()}}),this.widget.addEventListener("change",function(b){if(b.target)if(b.target.closest("[data-cc-add-pathway]")){var c=b.target.closest("[data-cc-add-pathway]"),d=c.querySelector("option:checked");"0"!=d.value&&(a.addPath(d),c.value="0")}else b.target.closest("[data-cc-pw-agg-changed]")&&(a.setOverallAggregation(!0),a.dirty=!0)}),this.widget.addEventListener("dragstart",function(a){if(a.target.closest("[data-cc-orderable]")){var b=a.target.closest("[data-cc-orderable]"),c=b.getAttribute("data-cc-orderable");a.dataTransfer.setData("orderKey",c)}}),this.widget.addEventListener("dragover",function(a){a.preventDefault()}),this.widget.addEventListener("drop",function(b){if(b.preventDefault(),b.target.closest("[data-cc-orderable]")){var c=b.dataTransfer.getData("orderKey"),d=a.widget.querySelector('[data-cc-orderable="'+c+'"]'),e=b.target.closest("[data-cc-orderable]");e.parentNode.insertBefore(d,e.nextSibling)}}),window.addEventListener("beforeunload",function(b){if(a.dirty)return b.preventDefault(),b.returnValue="",""})},bubbledEventsListener:function(){var a=this,b="totara_competency/pathway:";this.widget.addEventListener(b+"dirty",function(b){var c=b.detail.key;a.pathways[c]&&(a.pathways[c].dirty=!0),a.dirty=!0}),this.widget.addEventListener(b+"update",function(b){var c=b.detail.key,d=b.detail.pathway;a.pathways[c]||(a.pathways[c]={id:d.id?d.id:0,type:d.type?d.type:""},d.scalevalue&&(a.singlevalShown=!0),a.nPaths+=1,a.showHideNoPaths()),d.type&&delete d.type,a.pathways[c].detail=d}),this.widget.addEventListener(b+"remove",function(b){var c=b.detail.key;a.removePathway(c)}),this.widget.addEventListener(b+"singleuse",function(b){var c=b.detail.used;a.widget.setAttribute("data-singleuse",c?"1":"0"),a.toggleSingleUseCriteriaTypes(!c)})},setParent:function(a){this.widget=a},showNotification:function(a,b,c,d){"undefined"==typeof d&&(d={}),e.clearNotifications(),f.get_string(b,c,d).done(function(b){e.addNotification({message:b,type:a}),window.scrollTo(0,0)}).fail(e.exception)},initData:function(){var a=this;this.widget.hasAttribute("data-comp-id")&&(this.competency_id=this.widget.getAttribute("data-comp-id")),this.getCriteriaTypes().then(function(){a.setOverallAggregation()})["catch"](function(b){b.fileName=a.filename,b.name="Error retrieving criteria types",e.exception(b)})},getNextKey:function(){return this.lastKey++,"pw_new_"+this.lastKey},updatePage:function(){var c=this,d="totara_competency/partial_pathway_group",f=this.widget.querySelector("[data-pw-groups]"),g={args:{competency_id:c.competency_id},methodname:c.endpoints.pathways};return new Promise(function(h,i){b.getData(g).then(function(b){var g=b.results;c.pathways=[],c.nPaths=0,a.renderReplace(d,{criteria_types:c.criteriaTypes,pathway_groups:g},f).then(function(){h()})["catch"](function(a){a.fileName=c.filename,a.name="Error updating pathways",e.exception(a),i()})})["catch"](function(a){a.fileName=c.filename,a.name="Error retrieving pathways",e.exception(a),i()})})},addPath:function(b){var c=b.value,d=b.text,f="";if(b.hasAttribute("data-templatename")&&(f=b.getAttribute("data-templatename")),"0"!=c){if("singlevalue"===c)return this.singlevalShown=!0,void this.showHideNoPaths();var g,h,i=this,j=i.getNextKey(),k="totara_competency/partial_pathway";h={key:j,id:0,type:c,title:d,sortorder:0,pathway_templatename:f},this.pathways[j]=h,this.nPaths+=1,g=i.singlevalShown?i.widget.querySelector('[data-pw-group="high-sortorder"]'):i.widget.querySelector('[data-pw-group="low-sortorder"]'),a.renderAppend(k,this.pathways[j],g).then(function(){i.calculateSortorderFromDisplay(),i.dirty=!0,i.showHideNoPaths(),a.runTemplateJS("")})["catch"](function(a){a.fileName=i.filename,a.name="Error displayin "+c,e.exception(a)})}},hideCriteriaTypeSelectors:function(){for(var a=this.widget.querySelectorAll("[data-criteria-type-toggle]"),b=0;b<a.length;b++)a[b].classList.add("cc_hidden")},showCriteriaTypeOptions:function(a){var b=a.querySelector('[data-criteria-type-toggle="scalevalue"]'),c=!!b&&!b.classList.contains("cc_hidden");this.hideCriteriaTypeSelectors(),b&&!c&&b.classList.remove("cc_hidden")},addSinglevaluePath:function(b,c){var d,f,g,h,i=this,j="criteria_group",k=b.querySelector("[data-cc-scalevalue-pw-list]"),l="totara_competency/partial_pathway",m=c.getAttribute("data-scalevalue-criterion-type");d=this.getNextKey(),g=d+"_criterion_1",h=this.criteriaTypes.find(function(a){return a.type===m}),h.key=g,h.expandable=!h.singleuse,f={key:d,type:j,scalevalue:b.getAttribute("data-scalevalue-id"),sortorder:0,pathway_templatename:"pathway_criteria_group/pathway_criteria_group_edit",criteria_type_level:j,criteria_types:this.criteriaTypes,criteria:[h]},this.pathways[d]=f,this.nPaths+=1,a.renderAppend(l,f,k).then(function(){i.hideCriteriaTypeSelectors(),i.calculateSortorderFromDisplay(),i.dirty=!0,a.runTemplateJS("")})["catch"](function(a){a.fileName=i.filename,a.name="Error displayin "+j,e.exception(a)})},applyChanges:function(){var a,c,d,f,g,h=this,i=this.widget.querySelectorAll("[data-pw-save-endpoint]"),j=[];if(this.dirty){for(var k=Math.round(Date.now()/1e3),l=0;l<i.length;l++)a=i[l].getAttribute("data-pw-save-endpoint"),c=i[l].getAttribute("data-pw-save-req-sortorder"),d=i[l].closest("[data-pw-key]").getAttribute("data-pw-key"),this.pathways[d]&&this.pathways[d].dirty&&this.pathways[d].detail&&(g={args:this.pathways[d].detail,methodname:a},g.args.actiontime=k,c&&(f=i[l].closest("[data-pw-sortorder]"),f&&(g.args.sortorder=f.getAttribute("data-pw-sortorder"))),j.push(b.getData(g)));if(this.nDeletedPaths>0){var m=[];for(d in this.markedForDeletionPathways)m.push({type:this.markedForDeletionPathways[d].type,id:this.markedForDeletionPathways[d].id});g={args:{competency_id:this.competency_id,pathways:m,actiontime:k},methodname:this.endpoints.deletePathways},j.push(b.getData(g))}g={args:{competency_id:this.competency_id,type:this.aggType,actiontime:k},methodname:this.endpoints.setOverallAggregation},j.push(b.getData(g)),j.length>0&&Promise.all(j).then(function(){h.dirty=!1,h.updatePage().then(function(){h.showNotification("success","applysuccess","totara_competency",{})})["catch"](function(a){a.fileName=h.filename,a.name="Error updating the page",e.exception(a)})})["catch"](function(a){a.fileName=h.filename,a.name="Error applying changes",e.exception(a)})}},showHideNoPaths:function(){var a=this.widget.querySelector("[data-cc-pw-aggregation]"),b=this.widget.querySelector(".pw_none"),c=this.widget.querySelector('[data-pw-group="singlevalue"]'),d=this.widget.querySelector('[name="cc_add_pathway_select"] option[value="singlevalue"]');0!=this.nPaths||this.singlevalShown?(a&&a.classList.remove("cc_hidden"),b&&b.classList.add("cc_hidden")):(a&&a.classList.add("cc_hidden"),b&&b.classList.remove("cc_hidden")),this.singlevalShown?(c&&c.classList.remove("cc_hidden"),d&&(d.disabled=!0)):(c&&c.classList.add("cc_hidden"),d&&(d.disabled=!1))},calculateSortorderFromDisplay:function(){for(var a,b,c=this.widget.querySelectorAll("[data-pw-key]"),d=0,e=0;e<c.length;e++)a=c[e].getAttribute("data-pw-key"),this.pathways[a]?b=this.pathways[a]:this.markedForDeletionPathways[a]&&(b=this.markedForDeletionPathways[a]),b.sortorder!=d+1&&(this.pathways[a].dirty=!0,this.dirty=!0),b.sortorder=++d,c[e].setAttribute("data-pw-sortorder",b.sortorder)},cancelChanges:function(){if(this.widget.querySelector("[data-cc-cancel-href]")){var a=this.widget.querySelector("[data-cc-cancel-href]").getAttribute("data-cc-cancel-href");window.location.href=a}},removePathway:function(a){var b=this.widget.querySelector('[data-pw-key="'+a+'"]');this.widget.querySelector('[data-pw-or="'+a+'"]');if(this.pathways[a])if(this.dirty=!0,this.pathways[a].id&&0!=this.pathways[a].id){var c={};c[a]=this.pathways[a],Object.assign(this.markedForDeletionPathways,c),this.nDeletedPaths+=1,delete this.pathways[a];for(var d,e=b.querySelectorAll("[data-pw-on-delete]"),f=0;f<e.length;f++)d=e[f].getAttribute("data-pw-on-delete"),"mark"==d?e[f].classList.add("cc_deleted"):"hide"==d&&e[f].classList.add("cc_hidden");var g=b.querySelector('[data-pw-action="remove"]'),h=b.querySelector('[data-pw-action="undo"]');g.classList.add("cc_hidden"),h.classList.remove("cc_hidden")}else this.pathways[a].scalevalue,delete this.pathways[a],this.nPaths-=1,this.showHideNoPaths(),b&&b.remove(),this.dirty=!0},undoRemovePathway:function(a){var b=this.widget.querySelector('[data-pw-key="'+a+'"]'),c={};if(this.markedForDeletionPathways[a]){c[a]=this.markedForDeletionPathways[a],Object.assign(this.pathways,c),delete this.markedForDeletionPathways[a],this.nDeletedPaths-=1;for(var d,e=b.querySelectorAll("[data-pw-on-delete]"),f=0;f<e.length;f++)d=e[f].getAttribute("data-pw-on-delete"),"mark"==d?e[f].classList.remove("cc_deleted"):"hide"==d&&e[f].classList.remove("cc_hidden");var g=b.querySelector('[data-pw-action="remove"]'),h=b.querySelector('[data-pw-action="undo"]');g.classList.remove("cc_hidden"),h.classList.add("cc_hidden")}},getCriteriaTypes:function(){var a=this,c=this.widget.hasAttribute("data-singleuse")?this.widget.getAttribute("data-singleuse"):"0";return new Promise(function(d,f){if(a.criteriaTypes&&a.criteriaTypes.length>0)d();else{var g={args:{},methodname:a.endpoints.criteriaTypes};b.getData(g).then(function(b){var e=b.results;a.criteriaTypes=[];for(var f=0;f<e.length;f++)e[f].disabled=e[f].singleuse&&"1"==c,a.criteriaTypes.push(e[f]);d()})["catch"](function(b){b.fileName=a.filename,b.name="Error getting criteria types",e.exception(b),f()})}})},toggleSingleUseCriteriaTypes:function(a){for(var b,c,d,e,f,g=this.widget.querySelectorAll('[data-criteria-type-toggle="scalevalue"]'),h=0;h<g.length;h++)if(d=g[h].closest("[data-scalevalue-id]"),e=null,d&&(e=d.getAttribute("data-scalevalue-id")),e&&(b=g[h].querySelectorAll("[data-criteria-type-singleuse-active]"),c=g[h].querySelectorAll("[data-criteria-type-singleuse-disabled]"),0!=b.length))if(f=a){for(var i=0;i<b.length;i++)b[i].classList.remove("cc_hidden");for(var i=0;i<c.length;i++)c[i].classList.add("cc_hidden")}else{for(var i=0;i<b.length;i++)b[i].classList.add("cc_hidden");for(var i=0;i<c.length;i++)c[i].classList.remove("cc_hidden")}},setOverallAggregation:function(a){var b=this.widget.querySelector("[data-cc-pw-agg-changed]"),c=b.querySelector("option:checked"),d=this.widget.querySelector("[data-cc-pw-agg-actions]");this.aggType=c.value,c.hasAttribute("data-cc-pw-agg-function")?(this.aggFunction=c.getAttribute("data-cc-pw-agg-function"),d&&d.classList.remove("cc_hidden")):(this.aggFunction="",d&&d.classList.add("cc_hidden"))},enableOrdering:function(){for(var a,b=this.widget.querySelector('[data-cc-agg-action="edit"]'),c=this.widget.querySelector('[data-cc-agg-action="move"]'),d=this.widget.querySelectorAll("[data-cc-orderable]"),e=this.widget.querySelectorAll("[data-cc-on-ordering]"),f=0;f<d.length;f++)d[f].classList.add("cc_order_border"),d[f].draggable=!0;for(var f=0;f<e.length;f++)a=e[f].getAttribute("data-cc-on-ordering"),"hide"==a?e[f].classList.add("cc_hidden"):"show"==a?e[f].classList.remove("cc_hidden"):"disable"==a&&(e[f].disabled=!0);b&&(b.disabled=!1),c&&(c.disabled=!0)},disableOrdering:function(){for(var a,b=this.widget.querySelector('[data-cc-agg-action="edit"]'),c=this.widget.querySelector('[data-cc-agg-action="move"]'),d=this.widget.querySelectorAll("[data-cc-orderable]"),e=this.widget.querySelectorAll("[data-cc-on-ordering]"),f=0;f<d.length;f++)d[f].classList.remove("cc_order_border"),d[f].draggable=!1;for(var f=0;f<e.length;f++)a=e[f].getAttribute("data-cc-on-ordering"),"hide"==a?e[f].classList.remove("cc_hidden"):"show"==a?e[f].classList.add("cc_hidden"):"disable"==a&&(e[f].disabled=!1);b&&(b.disabled=!0),c&&(c.disabled=!1),this.aggFunction&&"function"==typeof this[this.aggFunction]&&this[this.aggFunction]()}};var h=function(a){return new Promise(function(b){var c=new g;c.setParent(a),c.events(),c.bubbledEventsListener(),c.initData(),b(c)})};return{init:h}});