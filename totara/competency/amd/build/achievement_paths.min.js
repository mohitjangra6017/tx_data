define(["core/templates","core/ajax","core/modal_factory","core/modal_events","core/notification","core/str"],function(a,b,c,d,e,f){function g(){return this instanceof g?(this.widget="",this.aggFunction="",this.aggType="",this.competencyId="",this.criteriaTypes=[],this.dirty=!1,this.draggedNode="",this.filename="achievement_paths.js",this.lastKey=0,this.markedForDeletionPathways=[],this.nDeletedPaths=0,this.nPaths=0,this.pathways=[],this.singlevalShown=!1,void(this.endpoints={criteriaTypes:"pathway_criteria_group_get_criteria_types",pathways:"totara_competency_get_pathways",deletePathways:"totara_competency_delete_pathways",setOverallAggregation:"totara_competency_set_overall_aggregation"})):new g}g.prototype={events:function(){var a=this;this.widget.addEventListener("click",function(b){if(b.target)if(b.target.closest("[data-tw-editAchievementPaths-action]")){var c=b.target.closest("[data-tw-editAchievementPaths-action]").getAttribute("data-tw-editAchievementPaths-action");"apply"===c?a.applyChanges():"cancel"===c&&a.cancelChanges()}else if(b.target.closest("[data-tw-editScaleValuePaths-add")){var d=b.target.closest("[data-tw-editScaleValuePaths-add]"),e=b.target.closest("[data-tw-editScaleValuePaths-scale-id]");d&&a.showCriteriaTypeDropDown(e)}else if(b.target.closest('[data-tw-editScaleValuePaths-dropDown-level="scalevalue"]')){var f=b.target.closest('[data-tw-editScaleValuePaths-dropDown-level="scalevalue"]'),g=b.target.closest("[data-tw-editScaleValuePaths-scale-id]");a.addSingleValuePath(g,f)}else if(b.target.closest("[data-tw-editAchievementPaths-pathway-action]")){var h=b.target.closest("[data-tw-editAchievementPaths-pathway-action]").getAttribute("data-tw-editAchievementPaths-pathway-action"),i=b.target.closest("[data-tw-editAchievementPaths-pathway-key]").getAttribute("data-tw-editAchievementPaths-pathway-key");"remove"===h?a.removePathway(i):"undo"===h&&a.undoRemovePathway(i)}else if(b.target.closest("[data-tw-editAchievementPaths-aggregation-action]")){var j=b.target.closest("[data-tw-editAchievementPaths-aggregation-action]"),k=j.getAttribute("data-tw-editAchievementPaths-aggregation-action");if(j.classList.contains("tw-editAchievementPaths__btn-active"))return;a.widget.querySelector(".tw-editAchievementPaths__btn-active").classList.remove("tw-editAchievementPaths__btn-active"),j.classList.add("tw-editAchievementPaths__btn-active"),"edit"===k?a.disableOrdering():"move"===k&&a.enableOrdering()}}),this.widget.addEventListener("change",function(b){if(b.target)if(b.target.closest("[data-tw-editAchievementPaths-add-pathway]")){var c=b.target.closest("[data-tw-editAchievementPaths-add-pathway]"),d=c.querySelector("option:checked");if("0"!=d.value){a.addPath(d),c.value="0";var e=document.querySelector("#add-pathway-sr-only");e.innerText=d.innerText+" "+e.dataset.ariaLiveExtraText}}else b.target.closest("[data-tw-editAchievementPaths-aggregation-change]")&&(a.setOverallAggregation(),a.dirty=!0)}),this.widget.addEventListener("dragstart",function(b){b.target.hasAttribute("data-tw-editAchievementPaths-draggable")&&(a.draggedNode=b.target)}),this.widget.addEventListener("dragend",function(){a.draggedNode=""}),this.widget.addEventListener("dragover",function(a){a.preventDefault()}),this.widget.addEventListener("dragenter",function(a){a.target.classList&&a.target.classList.contains("tw-editAchievementPaths__activeDropZone")&&a.target.classList.add("tw-editAchievementPaths__activeDropZone-over")}),this.widget.addEventListener("dragleave",function(a){a.target.classList&&a.target.classList.contains("tw-editAchievementPaths__activeDropZone")&&a.target.classList.remove("tw-editAchievementPaths__activeDropZone-over")}),this.widget.addEventListener("drop",function(b){if(b.preventDefault(),a.draggedNode){if(b.target.closest("[data-tw-editAchievementPaths-draggable]")){var c=b.target.closest("[data-tw-editAchievementPaths-draggable]"),d=c.closest("[data-tw-editAchievementPaths-group]").getAttribute("data-tw-editAchievementPaths-group"),e=a.draggedNode.closest("[data-tw-editAchievementPaths-group]").getAttribute("data-tw-editAchievementPaths-group"),f=a.widget.querySelector('[data-tw-editAchievementPaths-group="high-sortorder"]'),g=a.widget.querySelector('[data-tw-editAchievementPaths-group="low-sortorder"]');if("singlevalue"===e){var h,i;if("high-sortorder"===d){h=Array.prototype.slice.call(f.children),i=h.indexOf(c);for(var j=0;j<=i;j++)g.appendChild(h[j])}else if("low-sortorder"===d){h=Array.prototype.slice.call(g.children),i=h.indexOf(c);for(var k=i;k<h.length;k++)f.appendChild(h[k])}}else"singlevalue"===d?f.insertBefore(a.draggedNode,f.childNodes[0]):c.parentNode.insertBefore(a.draggedNode,c.nextSibling)}a.widget.querySelector(".tw-editAchievementPaths__activeDropZone-over").classList.remove("tw-editAchievementPaths__activeDropZone-over")}}),window.addEventListener("beforeunload",function(b){return a.dirty?(b.preventDefault(),b.returnValue="",""):""})},bubbledEventsListener:function(){var a=this,b="totara_competency/pathway:";this.widget.addEventListener(b+"dirty",function(b){var c=b.detail.key;a.pathways[c]&&(a.pathways[c].dirty=!0),a.dirty=!0}),this.widget.addEventListener(b+"update",function(b){var c=b.detail.key,d=b.detail.pathway;a.pathways[c]||(a.pathways[c]={id:d.id?d.id:0,type:d.type?d.type:""},d.scalevalue&&(a.singlevalShown=!0),a.nPaths+=1,a.showHideNoPaths()),d.type&&delete d.type,a.pathways[c].detail=d}),this.widget.addEventListener(b+"remove",function(b){var c=b.detail.key;a.removePathway(c)}),this.widget.addEventListener(b+"singleuse",function(b){var c=b.detail.used;a.widget.setAttribute("data-tw-editAchievementPaths-singleUse",c?"1":"0"),a.toggleSingleUseCriteriaTypes(!c)})},setParent:function(a){this.widget=a},showNotification:function(a,b,c,d){"undefined"==typeof d&&(d={}),e.clearNotifications(),f.get_string(b,c,d).done(function(b){e.addNotification({message:b,type:a}),window.scrollTo(0,0)}).fail(e.exception)},initData:function(){var a=this;this.competencyId=this.widget.getAttribute("data-tw-editAchievementPaths-competency"),this.getCriteriaTypes().then(function(){a.setOverallAggregation(),a.showHideNoPaths()})["catch"](function(b){b.fileName=a.filename,b.name="Error retrieving criteria types",e.exception(b)})},getNextKey:function(){return this.lastKey++,"pw_new_"+this.lastKey},updatePage:function(){var c=this,d="totara_competency/achievement_paths_group",f=this.widget.querySelector("[data-tw-editAchievementPaths-groups]"),g={args:{competency_id:c.competencyId},methodname:c.endpoints.pathways};return new Promise(function(h,i){b.getData(g).then(function(b){var g=b.results;c.pathways=[],c.nPaths=0,a.renderReplace(d,{criteria_types:c.criteriaTypes,pathway_groups:g},f).then(function(){c.singlevalShown=c.hasSingleValuePaths(),c.showHideNoPaths(),h()})["catch"](function(a){a.fileName=c.filename,a.name="Error updating pathways",e.exception(a),i()})})["catch"](function(a){a.fileName=c.filename,a.name="Error retrieving pathways",e.exception(a),i()})})},addPath:function(b){var c=b.value,d=b.text,f="";if(b.hasAttribute("data-tw-editAchievementPaths-path-template")&&(f=b.getAttribute("data-tw-editAchievementPaths-path-template")),"0"!=c){if("singlevalue"===c)return this.singlevalShown=!0,void this.showHideNoPaths();var g,h,i=this,j=i.getNextKey(),k="totara_competency/partial_pathway";h={key:j,id:0,type:c,title:d,sortorder:0,pathway_templatename:f},this.pathways[j]=h,this.nPaths+=1,g=i.singlevalShown?i.widget.querySelector('[data-tw-editAchievementPaths-group="high-sortorder"]'):i.widget.querySelector('[data-tw-editAchievementPaths-group="low-sortorder"]'),a.renderAppend(k,this.pathways[j],g).then(function(){i.calculateSortOrderFromDisplay(),i.dirty=!0,i.showHideNoPaths(),a.runTemplateJS("")})["catch"](function(a){a.fileName=i.filename,a.name="Error displaying "+c,e.exception(a)})}},hideCriteriaTypeSelectors:function(){for(var a=this.widget.querySelectorAll("[data-tw-editScaleValuePaths-dropDown]"),b=0;b<a.length;b++)a[b].classList.add("tw-editAchievementPaths--hidden");for(var c=document.querySelectorAll("[data-tw-editscalevaluepaths-add]"),b=0;b<c.length;b++)c[b].setAttribute("aria-expanded","false")},showCriteriaTypeDropDown:function(a){var b=a.querySelector('[data-tw-editScaleValuePaths-dropDown="scalevalue"]'),c=!b.classList.contains("tw-editAchievementPaths--hidden"),d=a.querySelector("[data-tw-editscalevaluepaths-add]");this.hideCriteriaTypeSelectors(),b&&!c&&(b.classList.remove("tw-editAchievementPaths--hidden"),d&&d.setAttribute("aria-expanded","true"))},addSingleValuePath:function(b,c){var d,f,g,h,i=this,j="criteria_group",k=b,l=parseInt(k.getAttribute("data-tw-editScaleValuePaths-pathway-list")),m="totara_competency/partial_pathway",n=c.getAttribute("data-tw-editScaleValuePaths-dropDown-item-type");d=this.getNextKey(),g=d+"_criterion_1",h=this.criteriaTypes.find(function(a){return a.type===n}),h.key=g,h.expandable=!h.singleuse,f={key:d,type:j,scalevalue:b.getAttribute("data-tw-editScaleValuePaths-scale-id"),sortorder:0,pathway_templatename:"pathway_criteria_group/pathway_criteria_group_edit",criteria_type_level:j,criteria_types:this.criteriaTypes,criteria:[h],showor:l>0},this.pathways[d]=f,this.nPaths+=1,a.renderAppend(m,f,k).then(function(){k.setAttribute("data-tw-editScaleValuePaths-pathway-list",l+1),i.hideCriteriaTypeSelectors(),i.calculateSortOrderFromDisplay(),i.dirty=!0,a.runTemplateJS("")})["catch"](function(a){a.fileName=i.filename,a.name="Error displaying "+j,e.exception(a)})},applyChanges:function(){var a,c,d,f,g,h=this,i=this.widget.querySelectorAll("[data-tw-editAchievementPaths-save-endPoint]"),j=[];if(this.dirty){for(var k=Math.round(Date.now()/1e3),l=0;l<i.length;l++)a=i[l].getAttribute("data-tw-editAchievementPaths-save-endPoint"),c=i[l].getAttribute("data-tw-editAchievementPaths-save-req-sortOrder"),d=i[l].closest("[data-tw-editAchievementPaths-pathway-key]").getAttribute("data-tw-editAchievementPaths-pathway-key"),this.pathways[d]&&this.pathways[d].dirty&&this.pathways[d].detail&&(g={args:this.pathways[d].detail,methodname:a},g.args.actiontime=k,c&&(f=i[l].closest("[data-tw-editAchievementPaths-pathway-sortOrder]"),f&&(g.args.sortorder=f.getAttribute("data-tw-editAchievementPaths-pathway-sortOrder"))),j.push(b.getData(g)));if(this.nDeletedPaths>0){var m=[];for(d in this.markedForDeletionPathways)m.push({type:this.markedForDeletionPathways[d].type,id:this.markedForDeletionPathways[d].id});g={args:{competency_id:this.competencyId,pathways:m,actiontime:k},methodname:this.endpoints.deletePathways},j.push(b.getData(g))}g={args:{competency_id:this.competencyId,type:this.aggType,actiontime:k},methodname:this.endpoints.setOverallAggregation},j.push(b.getData(g)),j.length>0&&Promise.all(j).then(function(){h.dirty=!1,h.updatePage().then(function(){h.showNotification("success","apply_success","totara_competency",{})})["catch"](function(a){a.fileName=h.filename,a.name="Error updating the page",e.exception(a)})})["catch"](function(a){a.fileName=h.filename,a.name="Error applying changes",e.exception(a)})}},showHideNoPaths:function(){var a=this.widget.querySelector("[data-tw-editAchievementPaths-aggregation]"),b=this.widget.querySelector("[data-tw-editAchievementPaths-empty]"),c=this.widget.querySelector('[data-tw-editAchievementPaths-group="singlevalue"]'),d=this.widget.querySelector('[data-tw-editAchievementPaths-add-pathway] option[value="singlevalue"]');0!=this.nPaths||this.singlevalShown?(a&&a.classList.remove("tw-editAchievementPaths--hidden"),b&&b.classList.add("tw-editAchievementPaths--hidden")):(a&&a.classList.add("tw-editAchievementPaths--hidden"),b&&b.classList.remove("tw-editAchievementPaths--hidden")),this.singlevalShown?(c&&c.classList.remove("tw-editAchievementPaths--hidden"),d&&(d.disabled=!0)):(c&&c.classList.add("tw-editAchievementPaths--hidden"),d&&(d.disabled=!1))},calculateSortOrderFromDisplay:function(){for(var a,b,c=this.widget.querySelectorAll("[data-tw-editAchievementPaths-pathway-key]"),d=0,e=0;e<c.length;e++)a=c[e].getAttribute("data-tw-editAchievementPaths-pathway-key"),this.pathways[a]?b=this.pathways[a]:this.markedForDeletionPathways[a]&&(b=this.markedForDeletionPathways[a]),b.sortorder!=d+1&&(this.pathways[a]?this.pathways[a].dirty=!0:this.markedForDeletionPathways[a]&&(this.markedForDeletionPathways[a].dirty=!0),this.dirty=!0),b.sortorder=++d,c[e].setAttribute("data-tw-editAchievementPaths-pathway-sortOrder",b.sortorder)},cancelChanges:function(){var a=this.widget.getAttribute("data-tw-editAchievementPaths-back-url");a&&(window.location.href=a)},removePathway:function(a){var b=this.widget.querySelector('[data-tw-editAchievementPaths-pathway-key="'+a+'"]');if(this.pathways[a])if(this.dirty=!0,this.pathways[a].id&&0!=this.pathways[a].id){var c={};c[a]=this.pathways[a],Object.assign(this.markedForDeletionPathways,c),this.nDeletedPaths+=1,delete this.pathways[a];for(var d,e=b.querySelectorAll("[data-pw-on-delete]"),f=0;f<e.length;f++)d=e[f].getAttribute("data-pw-on-delete"),"mark"==d?e[f].classList.add("tw-editAchievementPaths--deleted"):"hide"==d&&e[f].classList.add("tw-editAchievementPaths--hidden");var g=b.querySelector('[data-tw-editAchievementPaths-pathway-action="remove"]'),h=b.querySelector('[data-tw-editAchievementPaths-pathway-action="undo"]');g.classList.add("tw-editAchievementPaths--hidden"),h.classList.remove("tw-editAchievementPaths--hidden")}else{if(this.pathways[a].scalevalue){var i=this.widget.querySelector('[data-tw-editScaleValuePaths-scale-id="'+this.pathways[a].scalevalue+'"]'),j=this.widget.querySelector('[data-pw-or="'+a+'"]'),k=i,l=parseInt(k.getAttribute("data-tw-editScaleValuePaths-pathway-list"));if(j)j.remove();else{var m=i.querySelectorAll("[data-pw-or]");m.length>0&&m[0].remove()}l-=1,k.setAttribute("data-tw-editScaleValuePaths-pathway-list",l)}delete this.pathways[a],this.nPaths-=1,this.singlevalShown=this.hasSingleValuePaths(),this.showHideNoPaths(),b&&b.remove(),this.dirty=!0}},undoRemovePathway:function(a){var b=this.widget.querySelector('[data-tw-editAchievementPaths-pathway-key="'+a+'"]'),c={};if(this.markedForDeletionPathways[a]){c[a]=this.markedForDeletionPathways[a],Object.assign(this.pathways,c),delete this.markedForDeletionPathways[a],this.nDeletedPaths-=1;for(var d,e=b.querySelectorAll("[data-pw-on-delete]"),f=0;f<e.length;f++)d=e[f].getAttribute("data-pw-on-delete"),"mark"==d?e[f].classList.remove("tw-editAchievementPaths--deleted"):"hide"==d&&e[f].classList.remove("tw-editAchievementPaths--hidden");var g=b.querySelector('[data-tw-editAchievementPaths-pathway-action="remove"]'),h=b.querySelector('[data-tw-editAchievementPaths-pathway-action="undo"]');g.classList.remove("tw-editAchievementPaths--hidden"),h.classList.add("tw-editAchievementPaths--hidden")}},getCriteriaTypes:function(){var a=this,c=this.widget.hasAttribute("data-tw-editAchievementPaths-singleUse")?this.widget.getAttribute("data-tw-editAchievementPaths-singleUse"):"0";return new Promise(function(d,f){if(a.criteriaTypes&&a.criteriaTypes.length>0)d();else{var g={args:{},methodname:a.endpoints.criteriaTypes};b.getData(g).then(function(b){var e=b.results;a.criteriaTypes=[];for(var f=0;f<e.length;f++)e[f].disabled=e[f].singleuse&&"1"==c,a.criteriaTypes.push(e[f]);d()})["catch"](function(b){b.fileName=a.filename,b.name="Error getting criteria types",e.exception(b),f()})}})},toggleSingleUseCriteriaTypes:function(a){for(var b,c,d,e=this.widget.querySelectorAll('[data-tw-editScaleValuePaths-dropDown="scalevalue"]'),f=0;f<e.length;f++)if(b=e[f].closest("[data-tw-editScaleValuePaths-scale-id]"),c=null,d=e[f].querySelectorAll("[data-tw-editScaleValuePaths-dropDown-singleUse]"),b&&(c=b.getAttribute("data-tw-editScaleValuePaths-scale-id")),c&&d.length)if(a)for(var g=0;g<d.length;g++)d[g].removeAttribute("disabled");else for(var h=0;h<d.length;h++)d[h].setAttribute("disabled","")},setOverallAggregation:function(){var a=this.widget.querySelector("[data-tw-editAchievementPaths-aggregation-change]"),b=a.querySelector("option:checked"),c=this.widget.querySelector("[data-tw-editAchievementPaths-aggregation-actions]");this.aggType=b.value,b.hasAttribute("data-tw-editAchievementPaths-aggregation-function")?(this.aggFunction=b.getAttribute("data-tw-editAchievementPaths-aggregation-function"),c&&c.classList.remove("tw-editAchievementPaths--hidden")):(this.aggFunction="",c&&c.classList.add("tw-editAchievementPaths--hidden"))},enableOrdering:function(){for(var a,b=this.widget.querySelectorAll("[data-tw-editAchievementPaths-draggable]"),c=this.widget.querySelectorAll("[data-tw-editAchievementPaths-on-ordering]"),d=0;d<b.length;d++)b[d].classList.add("tw-editAchievementPaths__activeDropZone"),b[d].draggable=!0;for(var e=0;e<c.length;e++)a=c[e].getAttribute("data-tw-editAchievementPaths-on-ordering"),"hide"==a?c[e].classList.add("tw-editAchievementPaths--hidden"):"show"==a?c[e].classList.remove("tw-editAchievementPaths--hidden"):"disable"==a&&(c[e].disabled=!0)},disableOrdering:function(){for(var a,b=this.widget.querySelectorAll("[data-tw-editAchievementPaths-draggable]"),c=this.widget.querySelectorAll("[data-tw-editAchievementPaths-on-ordering]"),d=0;d<b.length;d++)b[d].classList.remove("tw-editAchievementPaths__activeDropZone"),b[d].draggable=!1;for(var e=0;e<c.length;e++)a=c[e].getAttribute("data-tw-editAchievementPaths-on-ordering"),"hide"==a?c[e].classList.remove("tw-editAchievementPaths--hidden"):"show"==a?c[e].classList.add("tw-editAchievementPaths--hidden"):"disable"==a&&(c[e].disabled=!1);this.aggFunction&&"function"==typeof this[this.aggFunction]&&this[this.aggFunction]()},hasSingleValuePaths:function(){return!!this.widget.querySelectorAll(".tw-editScaleValuePathsGroup").length}};var h=function(a){return new Promise(function(b){var c=new g;c.setParent(a),c.events(),c.bubbledEventsListener(),c.initData(),b(c)})};return{init:h}});