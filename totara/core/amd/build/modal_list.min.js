define(["core/str","core/templates","core/modal_factory","core/ajax"],function(a,b,c,d){function e(){if(!(this instanceof e))return new e}e.prototype.getKey=function(){return this.settings.key},e.prototype.initExtend=function(){this.setExtendingFunctions(),this.propagatedModalEvents()},e.prototype.prepareAdderBasket=function(){var a=this;return new Promise(function(b){d.getData({args:{basket:a.settings.basketKey},methodname:"totara_core_basket_show"}).then(function(c){var e=c.results.ids;a.list.disabledItems=e,d.getData({args:{basket:a.tempBasketKey},methodname:"totara_core_basket_delete"}).then(function(){b()})})})},e.prototype.prepareSelectorBasket=function(){var a=this;return new Promise(function(b){d.getData({args:{options:{replace:!0},sourcebasket:a.settings.basketKey,targetbasket:a.tempBasketKey},methodname:"totara_core_basket_copy"}).then(function(){b()})})},e.prototype.propagatedModalEvents=function(){var a=this.modal.getRoot(),b=this;a.on("modal-save-cancel:save",function(){var a="adder"!==b.settings.mode;d.getData({args:{options:{deletesource:!0,replace:a},sourcebasket:b.tempBasketKey,targetbasket:b.settings.basketKey},methodname:"totara_core_basket_copy"}).then(function(a){var c={args:b.list.getRequestArgs(),methodname:b.list.getWebservice()};c.args.filters={basket:b.settings.basketKey},c.args.page=0,d.getData(c).then(function(c){var d=c.results.items;b.reset(),b.settings.onSaved&&b.settings.onSaved(b,a.results.ids,d)})})}),a.on("modal:hidden",function(){b.basket&&b.basket.widget.classList.contains("tw-selectionBasket__displayed")&&(b.basket.onBasketHide(),b.basket.onBasketHidden()),b.reset(),b.settings.onClosed&&b.settings.onClosed()})},e.prototype.setExtendingFunctions=function(){var a=this,b=a.settings.events;b&&Object.keys(b).forEach(function(c){if(a[c])for(var d in a.settings.events[c])b[c].hasOwnProperty(d)&&"function"==typeof b[c][d]&&(a[c][d]=b[c][d].bind(a))})},e.prototype.show=function(){var a=this,b=new Promise(function(b){"adder"===a.settings.mode?a.prepareAdderBasket().then(function(){b()}):"selector"===a.settings.mode?a.prepareSelectorBasket().then(function(){b()}):b()});b.then(function(){a.loader.show(),"viewer"===a.settings.mode?a.list.update().then(function(){a.modal.show()}):a.updatePage([a.basket.updateBasketView(),a.list.getUpdateRequestArgs()]).then(function(){a.modal.show()})})};var f=function(a){return new Promise(function(b,c){void 0===a.key?c('Required option "key" has not been defined'):"viewer"!==a.mode&&void 0===a.basketKey?c('Required option "basketKey" has not been defined, this is required when using a '+a.basketKey):void 0===a.list?c('Required option "list" has not been defined'):void 0===a.list.service?c('Required list option "service" has not been defined'):void 0===a.list.map||"object"!=typeof a.list.map?c('Required list option "map" must be defined & must be of type object'):void 0===a.title?c('Required option "title" has not been defined'):b()})},g=function(a){return new Promise(function(d){k(a).then(function(e){var f="viewer"===a.mode?c.types.DEFAULT:c.types.SAVE_CANCEL;b.render("totara_core/basket_list",e).then(function(a){c.create({body:a,large:!0,title:e.title,type:f}).done(function(a){a.attachToDOM(),d(a)})})})})},h=function(b){return new Promise(function(c){var e=new Promise(function(c){b.placeholderString.value?c(b.placeholderString.value):a.get_string(b.placeholderString[0].key,b.placeholderString[0].component).then(c)});e.then(function(a){d.getData({args:b.serviceArgs,methodname:b.service}).then(function(d){var e=b.serviceLabelKey?b.serviceLabelKey:"name",f=[{active:!0,"default":!0,has_children:!1,name:a,key:""}];f=f.concat(d.results.items.map(function(a){return{active:!1,"default":!1,has_children:!1,key:a.id,name:a[e]}}));var g={primary_filter_tree:{active_name:a,flat_tree:!0,key:b.filterKey,options:f,parents_are_selectable:!0,partial:!0,show_border_box:!0,title_hidden:!0}};c(g)})})})},i=function(b){return new Promise(function(c){var d=new Promise(function(c){b.placeholderString.value?c(b.placeholderString.value):a.get_string(b.placeholderString[0].key,b.placeholderString[0].component).then(c)});d.then(function(a){var d={primary_filter_search:{key:b.filterKey,partial:!0,placeholder_show:!0,title:a,title_hidden:!0}};c(d)})})},j=function(b){return new Promise(function(c){var d=new Promise(function(c){b[0].value?c({title:b[0].value}):a.get_string(b[0].key,b[0].component).then(function(a){c({title:a})})});d.then(function(a){c(a)})})},k=function(a){var b={has_paging:!0,modal_display:!0,has_count:!0};return"adder"!==a.mode&&"selector"!==a.mode||(b.crumbs=null,b.hasToggleSelection=!0,b.selection_basket=!0),a.expandable&&(b.expandTemplate=a.expandable.template,b.expandTemplateWebservice=a.expandable.service,b.expandTemplateWebserviceArgs=a.expandable.args),a.list.map.hasHierarchy&&(b.crumbtrail_template_name="totara_core/crumb_with_title",b.has_crumbtrail=!0,b.has_level_toggle=a.levelToggle),new Promise(function(c){var d=[];a.title&&d.push(j(a.title)),a.primarySearch&&d.push(i(a.primarySearch)),a.primaryDropDown&&d.push(h(a.primaryDropDown)),Promise.all(d).then(function(a){for(var d=0;d<a.length;d++){var e=a[d];if("object"==typeof e)for(var f in e)b[f]=e[f]}c(b)})})},l=function(a){return new Promise(function(b){g(a).then(function(c){var d=a.basketKey?a.basketKey+"___temp":null,f=a.crumbtrail?a.crumbtrail:null,g={basketKey:d,crumbtrail:f,list:a.list,parent:c.body[0]},h=new Promise(function(b){"adder"===a.mode||"selector"===a.mode?require(["totara_core/basket_list"],function(a){b(a)}):require(["totara_core/view_list"],function(a){b(a)})});h.then(function(f){Object.assign(f.prototype,e.prototype);var h=new f;h.modal=c,h.settings=a,h.tempBasketKey=d,h.init(g).then(function(){b(h)})})})})},m=function(a){return new Promise(function(b,c){a.mode="adder",f(a).then(function(){a.list.map.hasCheckboxes=!0,l(a).then(function(a){b(a)})},function(b){c([a.key,b])})})},n=function(a){return new Promise(function(b,c){a.mode="selector",f(a).then(function(){a.list.map.hasCheckboxes=!0,l(a).then(function(a){b(a)})},function(b){c([a.key,b])})})},o=function(a){return new Promise(function(b,c){a.mode="viewer",f(a).then(function(){a.list.map.hasCheckboxes=!1,l(a).then(function(a){b(a)})},function(b){c([a.key,b])})})};return{adder:m,selector:n,viewer:o}});