define(["core/ajax","core/templates","core/notification","mod_facetoface/seminarevent_dashboard_action"],function(a,b,c,d){function e(a,b){var c,d;return function(){var e=this,f=arguments,g=function(){c=null,d&&(d=!1,a.apply(e,f))};c?(d=!0,clearTimeout(c)):a.apply(e,f),c=setTimeout(g,b||0)}}function f(a){var b="mod_facetoface_event-dashboard:";return b+=1===arguments.length?a:Array.prototype.reduce.call(arguments,function(a,b){return a+":"+b}),M.util.js_pending(b),function(){M.util.js_complete(b)}}function g(a){return this instanceof g?void this._init(a):new g(a)}function h(a,b){return this instanceof h?void this._init(a,b):new h(a,b)}(function(){this.constructor=g,this._init=function(a){var b={};"undefined"!=typeof a&&(0===a.indexOf("?")&&(a=a.substring(1)),a.length&&a.split("&").forEach(function(a){var c,d,e=a.indexOf("=");e!==-1?(c=decodeURIComponent(a.substring(0,e)),d=decodeURIComponent(a.substring(e+1))):(c=decodeURIComponent(a),d=""),b[c]=d})),this._items=b},this.toString=function(){var a="";for(var b in this._items)""!==a&&(a+="&"),a+=encodeURIComponent(b)+"="+encodeURIComponent(this._items[b]);return a},this.has=function(a){return a in this._items},this.get=function(a){return a in this._items?this._items[a]:null},this.forEach=function(a){for(var b in this._items)a(this._items[b],b)},this.set=function(a,b){this._items[a]=""+b},this["delete"]=function(a){delete this._items[a]}}).call(g.prototype),h.FILTER_CHANGED_EVENT="mod_facetoface:filter.changed",function(){var a="data-show-tooltips",b="mod_facetoface__filter--active";this.constructor=h,this._init=function(a,b){this.el=a,this.resetlink=a.querySelector(".mod_facetoface__filter__link"),this.filters=Array.prototype.slice.apply(a.querySelectorAll("select")),this.filterparams=new g,this.filters.forEach(function(a){var c=a.name,d=b.get(c);null!==d?(a.value=d,this.filterparams.set(c,d)):a.selectedIndex=0,this._updateTooltip(a)}.bind(this)),this.resetlink.addEventListener("click",this._onReset.bind(this)),a.addEventListener("change",this._onChange.bind(this)),this.filters.forEach(function(a){a.disabled=!1}),this.showResetLink()},this._onChange=function(a){var b=a.target.closest("select");this.filters.includes(b)!==!1&&(this._updateTooltip(b),b.selectedIndex>0?this.filterparams.set(b.name,b.value):this.filterparams["delete"](b.name),this._fireEvent())},this._onReset=function(a){var b=this,c=this.filters.filter(function(a){return a.selectedIndex>0&&(a.selectedIndex=0,b.filterparams["delete"](a.name),b._updateTooltip(a),!0)});c.length&&this._fireEvent(),a.preventDefault()},this._updateTooltip=function(b){if("true"==b.getAttribute(a)){var c="",d=b.selectedIndex;0<d&&d<b.options.length&&(c=b.options[d].text),b.setAttribute("title",c)}},this._fireEvent=function(){var a=new CustomEvent(h.FILTER_CHANGED_EVENT,{bubbles:!0,detail:this});this.el.dispatchEvent(a)},this.showResetLink=function(){var a=this.filters.filter(function(a){return a.selectedIndex>0});a.length?this.el.classList.add(b):this.el.classList.remove(b)},this.forEachParams=function(a){this.filterparams.forEach(a)},this.setParam=function(a,b){this.filterparams.set(a,b)},this.deleteParam=function(a){this.filterparams["delete"](a)},this.getParamsString=function(){return this.filterparams.toString()}}.call(h.prototype);var i={args:{id:null,f:null,type:"",cookie:0,filterparams:{},debug:!1},requestCookie:0,filter:null,initDone:!1,init:function(a){this.el=a;var b=this,c=f("init");setTimeout(function(){var d=b._loadParams(),e=a.querySelector(".mod_facetoface__filter");null!==e&&(b.filter=new h(e,d),a.addEventListener(h.FILTER_CHANGED_EVENT,b._onFilterChanged.bind(b))),a.addEventListener("click",b._onClick.bind(b)),a.addEventListener("scroll",b._onScroll.bind(b),!0),b.update(!0,!0),b.initDone=!0,c()},0)},_loadParams:function(){var a=new g(location.search),b=a.get("id");return null!==b?this.args.id=parseInt(b,10):(b=a.get("f"),null!==b&&(this.args.f=parseInt(b,10))),1==a.get("debug")&&(this.args.debug=1),a},_onFilterChanged:e(function(a){var b=a.detail;b===this.filter&&this.update(!0,!0)},400),_onClick:function(a){if(this.filter){var b=a.target.closest(".mod_facetoface__sessionlist__show-previous__link");if(null!==b){a.preventDefault();var c=/\ballpreviousevents=(\d+)/.exec(b.getAttribute("href"));c&&c[1]?this.filter.setParam("allpreviousevents",1):this.filter.deleteParam("allpreviousevents"),this.update(!1,!0)}}},_onScroll:function(a){a.target.classList.contains("mod_facetoface__sessionlist")&&d.update()},update:function(a,b){if(a||b){var c=this.filterParams();history.replaceState({ajax:!0,filter:c},"",this.url()),this.initDone&&this.filter&&this.filter.showResetLink();var d=++this.requestCookie;a&&this.updateWorker("upcoming",d,c),b&&this.updateWorker("past",d,c)}},updateWorker:function(a,d,e){var g=this,h=this.el,i=h.querySelector(".mod_facetoface__sessions--"+a),j=i.querySelector(".mod_facetoface__sessionlist__appendix"),k=i.querySelector(".mod_facetoface__sessionlist"),l=i.querySelector(".mod_facetoface__sessions__debug"),m=i.querySelector(".mod_facetoface__sessions__empty");m.setAttribute("aria-hidden","true"),i.classList.add("loading"),i.classList.remove("empty"),i.classList.remove("debug"),j.innerHTML="",k.innerHTML="",l.innerHTML="";var n=f("update",a,d);this.fetch(a,d,e).then(function(c){if(g.requestCookie===c.cookie){var e=h.querySelector(".mod_facetoface__event-dashboard__title");if(e.textContent=c.title,"table"in c.data){var o=c.data.table,p=f("update-table",a,d);b.render(o.template,o.data).done(function(a,c){k.innerHTML=a,i.classList.remove("loading"),b.runTemplateJS(c),p()})}else i.classList.remove("loading"),m.setAttribute("aria-hidden","false"),i.classList.add("empty");"debug"in c&&"query"in c.debug&&(l.innerHTML=c.debug.query,i.classList.add("debug")),j.innerHTML=c.data.reservation||c.data.pastlink||"",n()}else n()})["catch"](c.exception)},url:function(){var a=location.href.replace(/\?.*$/,"")+"?";if(a+=this.args.id?"id="+this.args.id:"f="+this.args.f,this.args.debug&&(a+="&debug=1"),!this.filter)return a;var b=this.filter.getParamsString();return b?a+"&"+b:a},filterParams:function(){if(!this.filter)return{};var a={};return this.filter.forEachParams(function(b,c){a[c]=b}),a},fetch:function(b,d,e){var f=Object.assign(this.args,{type:b,cookie:d,filterparams:e}),g=a.call([{methodname:"mod_facetoface_render_session_list",args:f}],!0,!0);return g[0].fail(function(a){c.exception(a)})}};return i});