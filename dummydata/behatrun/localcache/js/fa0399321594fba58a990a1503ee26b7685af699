M.totara_reportbuilder_expand=M.totara_reportbuilder_expand||{SELECTORS:{ENROLMENTBUTTONS:'.expandenrol'},init:function(Y,args){$('body').on('click','.rb-display-expand',M.totara_reportbuilder_expand.displayExpand);$('body').on('click','input'+this.SELECTORS.ENROLMENTBUTTONS,M.totara_reportbuilder_expand.clickEnrol);$('body').on('click','.rb-display-expand-link',function(event){event.stopPropagation()})},displayExpand:function(event){var that=this;if($(this).attr('clicked')){$('.rb-expand-row').remove();$(this).attr({clicked:null});return}
var id=$('.rb-display-table-container').attr('id');var url=M.cfg.wwwroot+'/totara/reportbuilder/ajax/expand.php?id='+id+'&expandname='+$(this).data('name')+'&sesskey='+M.cfg.sesskey;if($(this).data('param')){url=url+'&'+$(this).data('param')}
$.post(url).done(function(data){$('.rb-expand-row').remove();$('.rb-display-table-container div').attr({clicked:null});var content=$(data).find('.rb-expand-row');var colspan=$(that).closest('tr').find('td').length;content.find('td.rb-expand-cell').attr({colspan:colspan});content.insertAfter($(that).closest('tr'));$(that).attr({clicked:!0})})},clickEnrol:function(event){event.stopPropagation();var button=$(event.target);var courseid=$('input[type="hidden"][name="courseid"]').attr('value');var id=$('.rb-display-table-container').attr('id');var url=M.cfg.wwwroot+'/totara/reportbuilder/ajax/expand.php';var form=$(button).parents('form')[0];var formdata=$(form).serialize();formdata+='&expandname=course_details';formdata+='&expandcourseid='+courseid;formdata+='&id='+id;formdata+='&instancesubmitted='+button.attr('name');var that=$('[data-param="expandcourseid='+courseid+'"]');$.post(url,formdata).done(function(data){if(data.hasOwnProperty('error')){if(M.cfg.developerdebug){YUI().use('moodle-core-notification-ajaxexception',function(){new M.core.ajaxException(data)})}else{YUI().use('moodle-core-notification-alert',function(){new M.core.alert({message:data.error,title:M.util.get_string('error','moodle')})})}}
var redirect=$(data).find('input[type="hidden"][name="redirect"]');if(redirect.length){window.location=redirect.attr('value');return}
if(data==='success'){$('.rb-expand-row').remove();$('.rb-display-table-container div').attr({clicked:null});that.trigger("click")}
$('.rb-expand-row').remove();$('.rb-display-table-container div').attr({clicked:null});var content=$(data).find('.rb-expand-row');var colspan=$(that).closest('tr').find('td').length;content.find('td.rb-expand-cell').attr({colspan:colspan});content.insertAfter($(that).closest('tr'));that.attr({clicked:!0})})}}