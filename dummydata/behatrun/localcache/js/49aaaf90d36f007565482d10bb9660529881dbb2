M.totara_coursecohort=M.totara_coursecohort||{Y:null,config:{},init:function(Y,args){this.Y=Y;if(args){var jargs=Y.JSON.parse(args);for(var a in jargs){if(Y.Object.owns(jargs,a)){this.config[a]=jargs[a]}}}
if(typeof $==='undefined'){throw new Error('M.totara_cohortlearning.init()-> jQuery dependency required for this module.')}
this.config.sesskey=M.cfg.sesskey;if(this.config.instancetype==40){var select=$('select[name="category"] option:selected'),categoryid=(select)?select.val():!1;if(categoryid!==undefined&&categoryid!=this.config.instanceid){this.config.instanceid=categoryid}}
this.init_dialogs()},init_dialogs:function(){var url=M.cfg.wwwroot+'/totara/cohort/dialog/';var ehandler=new totaraDialog_handler_coursecohorts();ehandler.baseurl=url;var dbuttons={};dbuttons[M.util.get_string('ok','moodle')]=function(){ehandler._update()}
dbuttons[M.util.get_string('cancel','moodle')]=function(){ehandler._cancel()}
totaraDialogs.id_cohortsaddenrolled=new totaraDialog('course-cohorts-enrolled-dialog','id_cohortsaddenrolled',{buttons:dbuttons,title:'<h2>'+M.util.get_string('coursecohortsenrolled','totara_cohort')+'</h2>'},url+'cohort.php?selected='+this.config.enrolledselected+'&instancetype='+this.config.instancetype+'&instanceid='+this.config.instanceid,ehandler)}}
totaraDialog_handler_coursecohorts=function(){this.baseurl='';this.cohort_items=$('input:hidden[name="cohortsenrolled"]').val();this.cohort_items=(this.cohort_items&&this.cohort_items.length>0)?this.cohort_items.split(','):[];this.cohort_table=$('#course-cohorts-table-enrolled');this.add_cohort_delete_event_handlers();this.check_table_hidden_status()}
totaraDialog_handler_coursecohorts.prototype=new totaraDialog_handler_treeview_multiselect();totaraDialog_handler_coursecohorts.prototype._update=function(response){var self=this;var elements=$('.selected > div > span',this._container);var selected_str=this._get_ids(elements).join(',');var url=this._dialog.default_url.split("selected=");var params=url[1].slice(url[1].indexOf('&'));this._dialog.default_url=url[0]+'selected='+selected_str+params;var newids=new Array();elements.each(function(){var itemid=$(this).attr('id').split('_');itemid=itemid[itemid.length-1];itemid=parseInt(itemid);if(!self.cohort_item_exists(itemid)){newids.push(itemid);self.add_cohort_item(itemid)}});if(newids.length>0){this._dialog.showLoading();var ajax_url=M.cfg.wwwroot+'/totara/cohort/dialog/cohort_item.php?module=course&itemid='+newids.join(',')+params;$.getJSON(ajax_url,function(data){if(data.error){self._dialog.hide();alert(data.error);return}
$.each(data.rows,function(index,html){self.create_item(html)});self._dialog.hide()})}else{this._dialog.hide()}}
totaraDialog_handler_coursecohorts.prototype.cohort_item_exists=function(itemid){for(x in this.cohort_items){if(this.cohort_items[x]==itemid){return!0}}
return!1}
totaraDialog_handler_coursecohorts.prototype.check_table_hidden_status=function(){if(this.cohort_items.length==0){$(this.cohort_table).hide()}else{$(this.cohort_table).show()}}
totaraDialog_handler_coursecohorts.prototype.add_cohort_delete_event_handlers=function(){$('.coursecohortdeletelink',this.cohort_table).unbind('click');var self=this;this.cohort_table.on('click','.coursecohortdeletelink',function(event){event.preventDefault();self.remove_cohort_item(this)})}
totaraDialog_handler_coursecohorts.prototype.add_cohort_item=function(itemid){this.cohort_items.push(itemid);$('input:hidden[name="cohortsenrolled"]').val(this.cohort_items.join(','));this.check_table_hidden_status()}
totaraDialog_handler_coursecohorts.prototype.create_item=function(html){var element=$(html);this.cohort_table.append(element)}
totaraDialog_handler_coursecohorts.prototype.remove_cohort_item=function(item){var itemid=$(item).closest('div').attr('id').match(/[\d]+$/);var row=$(item).closest('tr');this.cohort_items=$.grep(this.cohort_items,function(element,x){return(element==itemid)},!0);row.remove()
this.check_table_hidden_status();$('input:hidden[name="cohortsenrolled"]').val(this.cohort_items.join(','));var url=this._dialog.default_url.split("selected=");var params=url[1].slice(url[1].indexOf('&'));this._dialog.default_url=url[0]+'selected='+this.cohort_items.join(',')+params}