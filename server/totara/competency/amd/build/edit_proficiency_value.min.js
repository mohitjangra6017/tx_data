define(["core/str","core/modal_factory","core/modal_events","totara_competency/basket_list","core/ajax","core/notification","core/templates","core/webapi"],function(a,b,c,d,e,f,g,h){function i(){return this instanceof i?(this.scaleCache={},void(this.frameworkId=null)):new i}var j="[name=editProficiencyValue]",k="[name=editProficiencyValue]:checked";i.prototype=new d,i.prototype.customBubbledEventsListener=function(){var b=this;this.listParent.addEventListener(this.basketManager.getEventListener()+":customUpdate",function(){b.showModal(b.createValueSelectionModal()).then(function(c){if(c.confirmed){b.loader.show();var d,e=c.modal.getRoot().find(k),g=e.val(),h="remove"===g?null:g;d=1===b.list.selectedItems.length?a.get_string("edit_proficiency_value_by_assignment_updated_single","totara_competency"):a.get_string("edit_proficiency_value_by_assignment_updated","totara_competency",b.list.selectedItems.length);var i=b.updateMinProficiencyValues(h);Promise.all([d,i]).then(function(a){b.showNotification(a[0]),b.resetListAndBasket()})["catch"](f.exception)}})})},i.prototype.updateMinProficiencyValues=function(a){return h.call({operationName:"totara_competency_update_min_proficiency_override_for_assignments",variables:{input:{assignment_ids:this.list.selectedItems,scale_value_id:a}}})},i.prototype.showNotification=function(a){f.clearNotifications(),f.addNotification({message:a,type:"success"}),window.scrollTo(0,0)},i.prototype.resetListAndBasket=function(){var a=this;this.basketManager.deleteAndRender().then(function(){a.updatePage([a.list.getUpdateRequestArgs()])})},i.prototype.createValueSelectionModal=function(){var c=a.get_string("edit_proficiency_bulk_modal_title","totara_competency",this.list.selectedItems.length),d=this.loadCompetencyScale(),e=g.render("core/modal_backdrop",null),f=this;return Promise.all([c,d,e]).then(function(a){var c=a[0],d=a[1],e=g.render("totara_competency/edit_proficiency_value_modal",f.getModalTemplateData(d));return b.create({body:e,title:c,type:b.types.SAVE_CANCEL}).then(function(a){return a.disableSave(),a.getRoot().find(j).off().change(function(){a.enableSave()}),a})})},i.prototype.showModal=function(a){this.loader&&this.loader.show();var b=this;return a.then(function(a){return b.displayModal(a)})},i.prototype.createFrameworkChangeConfirmModal=function(){var c=a.get_strings([{key:"edit_proficiency_change_framework_warning",component:"totara_competency"},{key:"filter_select_competency_framework",component:"totara_competency"},{key:"confirm",component:"moodle"},{key:"cancel",component:"moodle"}]),d=g.render("core/modal_backdrop",null);return Promise.all([c,d]).then(function(a){var c=a[0];return b.create({body:c[0],title:c[1],type:b.types.CONFIRM},void 0,{yesstr:c[2],nostr:c[3]})})},i.prototype.loadCompetencyScale=function(){var a=this.frameworkId;if(this.scaleCache[a]){var b=this.scaleCache[a];return Promise.resolve(b)}var c=this;return h.call({operationName:"totara_competency_scale",variables:{framework_id:a}}).then(function(b){var d=b.totara_competency_scale;if(!d)throw new Error("No scale found for framework id "+a);return c.scaleCache[a]=d,d})},i.prototype.getModalTemplateData=function(a){var b=!1,c=a.values.sort(function(a,b){return b.sortorder-b.sortorder}).map(function(a){var c={id:a.id,name:a.name,isDefaultProficiency:!1};return!b&&a.proficient&&(c.isDefaultProficiency=!0,b=!0),c}).reverse();return{values:c}},i.prototype.displayModal=function(a){var b=a.getRoot(),d=this;return b.on(c.shown,function(){d.loader&&d.loader.hide()}),a.show(),new Promise(function(d){var e={confirmed:!0,modal:a};b.off(c.yes),b.on(c.yes,d.bind(a,e)),b.off(c.save),b.on(c.save,d.bind(a,e));var f={confirmed:!1,modal:a};b.off(c.no),b.on(c.no,d.bind(a,f)),b.off(c.cancel),b.on(c.cancel,d.bind(a,f)),b.off(c.hidden),b.on(c.hidden,d.bind(a,f))})},i.prototype.initExtend=function(){this.customBubbledEventsListener(),this.selectors.clearPrimaryTree=function(){},this.filters.clearFilters=function(){this.filters={framework:this.getFilter("framework")}};var a=this,b=this.filters.onFiltersUpdate.bind(this.filters);this.filters.onFiltersUpdate=function(){var c=this.getFilter("framework");this.frameworkId!==c&&(a.shouldShowConfirmFrameworkModal(c)?a.showConfirmFrameworkModal(c):a.frameworkId=c),b()}},i.prototype.shouldShowConfirmFrameworkModal=function(a){return!!a&&(this.frameworkId!==a&&this.list.selectedItems.length>0)},i.prototype.showConfirmFrameworkModal=function(a){var b=this;return this.showModal(b.createFrameworkChangeConfirmModal()).then(function(c){c.confirmed?(b.frameworkId=a,b.loadCompetencyScale(),b.basketManager.deleteAndRender()):(b.filters.setFilter("framework",b.frameworkId),b.selectors.setPrimaryTreeValue(b.frameworkId),b.list.update())})};var l=function(a){return{actions:a.actionsCallback,cols:[{dataPath:"competency_name",headerString:{component:"totara_competency",key:"header_competency"}},{dataPath:"assignment_type_name",headerString:{component:"totara_competency",key:"header_assignment_type"}},{dataPath:"user_group_name",headerString:{component:"totara_competency",key:"assigned_type_detail"}},{dataPath:"min_proficiency_value_name",headerString:{component:"totara_competency",key:"min_required_proficiency_value"}},{dataPath:"has_default_proficiency_value_override_yes_no",headerString:{component:"totara_competency",key:"default_proficiency_value_override_header"},size:"xs"}],extraRowData:[{key:"user_group_type",dataPath:"user_group_type"}],hasHierarchy:!1}},m=function(a){return new Promise(function(b){var c=new i,d={basketKey:"totara_competency_edit_proficiency_value",basketType:"simple",list:{map:l(c),service:"totara_competency_assignment_index"},parent:a};c.init(d).then(function(){c.createValueSelectionModal(),c.createFrameworkChangeConfirmModal(),b(c)})})};return{init:m}});