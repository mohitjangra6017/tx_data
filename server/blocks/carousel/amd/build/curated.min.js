define(["jquery","core/templates","core/modal_factory","block_carousel/modal_curated","block_carousel/select2","block_carousel/slick","block_carousel/colorthief"],function(a,b,c,d,e,f,g){function h(){var b={blockinstanceid:null,carouseltype:null,curatedid:0,edit_cog:null,"delete":null,loadingcarousel:!1,spinner:'<i class="fa fa-spinner fa-spin spinner"></i>',init:function(c){b.blockinstanceid=c,b.init_modal(),a(document).on("click","#btn-curated-config-trigger",function(){b.carouseltype=a("#id_config_carouseltype").val(),b.curatedid=a("#curated-configuration-from").find("#curatedid").val(),b.add_search_fields()}),a(document).on("change","select.select2",function(){b.preview_cluster()}),a(document).on("click","#save-cluster",function(){b.save_cluster()}),a(document).on("click",".edit-cluster",function(){b.edit_cog=a(this),b.edit_cog.addClass("fa-spin"),b.curatedid=a(this).data("curatedid"),b.add_search_fields()}),a(document).on("click","#add-new-cluster",function(){b.curatedid=0,a("#curated-configuration-from").find("#curatedid").val(0),b.add_search_fields()}),a(document).on("click",".delete-cluster",function(){b["delete"]=a(this),b.delete_cluster()})},init_cluster:function(c){b.blockinstanceid=c,a(document).on("click","#carousel-nested-"+b.blockinstanceid+" .toggle-card-details",function(){if(a(this).hasClass("hasContent"))return a("#carousel-nested-clusters-"+b.blockinstanceid).html(""),a("#carousel-nested-"+b.blockinstanceid+" .main-cluster").removeClass("showing-nested"),a(this).removeClass("hasContent"),!1;if(!b.loadingcarousel){a("#carousel-nested-"+b.blockinstanceid+" .toggle-card-details").removeClass("hasContent"),b.loadingcarousel=!0;var c=a(this).data("courseids"),d=a(this).data("cardcount");b.get_cluster_carousel(c,d,a(this)),a("#carousel-nested-"+b.blockinstanceid+" .main-cluster").addClass("showing-nested")}})},get_cluster_carousel:function(c,d,e){a("#carousel-nested-clusters-"+b.blockinstanceid).addClass("loading").html(b.spinner),a.ajax({method:"POST",url:M.cfg.wwwroot+"/blocks/carousel/ajax/get_cluster_carousel.php",dataType:"HTML",data:{blockinstanceid:b.blockinstanceid,courseids:c,cardcount:d}}).done(function(c){a("#carousel-nested-clusters-"+b.blockinstanceid).removeClass("loading").html(c),e.addClass("hasContent"),b.initslick(d),b.loadingcarousel=!1})},initslick:function(c){var d={asNavFor:"#carousel-nav-"+b.blockinstanceid,slidesToShow:c,slidesToScroll:1,centerMode:!1,focusOnSelect:!0,responsive:[{breakpoint:1200,settings:{slidesToShow:3,slidesToScroll:1}},{breakpoint:768,settings:{slidesToShow:2,slidesToScroll:1}},{breakpoint:600,settings:{slidesToShow:1,slidesToScroll:1}}]},e={slidesToShow:1,slidesToScroll:1,arrows:!1,fade:!0,draggable:!1,accessibility:!1},h=f.init("#carousel-nav-"+b.blockinstanceid,e);f.init("#carousel-"+b.blockinstanceid,d);h.hide(),a("#carousel-"+b.blockinstanceid+" article.learning .toggle-card-details").click(function(){h.show(),a("#carousel-"+b.blockinstanceid).addClass("showing-details"),a(window).trigger("resize");var c=a("#carousel-nav-"+b.blockinstanceid+" .slick-track").css("width");"0px"==c&&(a("#carousel-nav-"+b.blockinstanceid+" .slick-track").css("width","100%"),a("#carousel-nav-"+b.blockinstanceid+" .slick-track .slick-slide.slick-active").css("width","100%"))}),a("#carousel-"+b.blockinstanceid+" article.learning figure.tile").click(function(b){return a(this).data("displayinmodal")?void a(this).siblings(".toggle-card-details").trigger("click"):(b.stopPropagation(),window.location.href=a(this).data("url"),!1)}),a("#carousel-nav-"+b.blockinstanceid+" .close-slide-details").click(function(){h.hide("fast"),a("#carousel-"+b.blockinstanceid).removeClass("showing-details"),a(window).trigger("resize")}),a("#carousel-nav-"+b.blockinstanceid+" article").each(function(){const b=a(this),c=a(this).find("img.hidden:first").attr("src"),d=new Image;d.onload=function(){const e=g.init(),f=e.getColor(d);var h=f[0],i=f[1],j=f[2];const k=Math.sqrt(.299*h*h+.587*i*i+.114*j*j)/255;b.addClass(k>.6?"dark-text":"light-text");const l=g.rgbCode(f,1);a(this).css("background-image","linear-gradient(to right,"+l+" 0% 15%, "+l+" 15% 58%, transparent 70% 100%), url("+c+")")}.bind(this),d.src=c}),a("#carousel-nav-"+b.blockinstanceid+" article.learning-details .launch-courselet").click(function(){a.ajax({method:"POST",url:"/blocks/carousel/ajax/process_courselet.php",dataType:"JSON",data:{courseid:a(this).data("courseid"),nodisplay:1}}).done(function(){})})},init_modal:function(){var b=a("#btn-curated-config-trigger");c.create({type:d.TYPE},b).done(function(a){var b=a.getRoot();b.addClass("carousel-curated-modal")})},add_search_fields:function(){a.ajax({method:"POST",url:M.cfg.wwwroot+"/blocks/carousel/ajax/curated_filters.php",dataType:"JSON",data:{blockinstanceid:b.blockinstanceid,carouseltype:b.carouseltype,curatedid:b.curatedid}}).done(function(c){a("#curated-filters").html(c.html),e.init(),"cluster"==b.carouseltype&&a("#add-new-cluster").removeClass("hide"),b.preview_cluster()})},preview_cluster:function(){a.ajax({method:"POST",url:M.cfg.wwwroot+"/blocks/carousel/ajax/preview_cluster.php",dataType:"JSON",data:a("#curated-configuration-from").serialize()+"&carouseltype="+b.carouseltype+"&blockinstanceid="+b.blockinstanceid}).done(function(c){a("#curated-contents").html(c.html),b.edit_cog&&b.edit_cog.removeClass("fa-spin")})},save_cluster:function(){var c=a("#save-cluster").html();a("#save-cluster").html("Saving...");var d=a("#curated-configuration-from"),e=new FormData(d[0]);e.append("blockinstanceid",b.blockinstanceid),a.ajax({method:"POST",url:M.cfg.wwwroot+"/blocks/carousel/ajax/save_cluster.php",data:e,enctype:"multipart/form-data",contentType:!1,cache:!1,processData:!1}).done(function(){a("#save-cluster").html("Saved"),setTimeout(function(){a("#save-cluster").html(c)},3e3)})},delete_cluster:function(){var c=b["delete"].data("curatedid");b["delete"].parent().siblings().html("Deleting..."),a.ajax({method:"POST",url:M.cfg.wwwroot+"/blocks/carousel/ajax/delete_cluster.php",dataType:"JSON",data:{blockinstanceid:b.blockinstanceid,curatedid:c}}).done(function(){b.curatedid=0,a("#curated-configuration-from").find("#curatedid").val(0),b.add_search_fields()})}};return b}var i={},j=h();for(var k in j)j[k]instanceof Function&&"init"==k.substr(0,4)&&(i[k]=function(a){return function(){var b=h();b[a].apply(b,arguments)}}(k));return i});