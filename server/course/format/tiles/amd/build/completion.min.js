define ("format_tiles/completion",["jquery","core/templates","core/config","core/ajax","format_tiles/completion"],function(a,b,c,d){"use strict";var e,f={},g={cmid:"data-cmid",numberComplete:"data-numcomplete",numberOutOf:"data-numoutof",section:"data-section"},h={launchModuleModal:"[data-action=\"launch-tiles-module-modal\"]",launchResourceModal:"[data-action=\"launch-tiles-resource-modal\"]",pageContent:"#page-content",regionMain:"#region-main",resourceModule:".activity.resource",completeonevent:".completeonevent",completeonview:".completeonview",activity:"li.activity",section:"li.section.main",togglecompletion:"form.togglecompletion",tileId:"#tile-",progressIndicatorId:"#tileprogress-",tile:".tile",spacer:".spacer",availabilityinfo:".availabilityinfo",sectionId:"#section-"},i={completionYes:"completion-icon-y",completionNo:"completion-icon-n"},j=[],k=function(b,c,d,e){var f={tileid:b,numComplete:c,numOutOf:d,showAsPercent:e,percent:Math.round(100*(c/d)),percentCircumf:106.8,percentOffset:Math.round(106.8*((d-c)/d)),isComplete:!1,isSingleDigit:!1,hastilephoto:a(h.tileId+b).hasClass("phototile")};if(0===b){f.isOverall=1}else{f.isOverall=0}if(c>=d){f.isComplete=!0}if(10>f.percent){f.isSingleDigit=!0}return f},l=function(c,d,e){if(0===d.attr(g.numberComplete)&&0>e){return}var f=Math.min(parseInt(d.attr(g.numberComplete))+e,d.attr(g.numberOutOf)),i=a("#tileprogress-0"),j=Math.min(parseInt(i.attr(g.numberComplete))+e,i.attr(g.numberOutOf));b.render("format_tiles/progress",k(c,f,d.attr(g.numberOutOf),d.hasClass("percent"))).done(function(b){d.replaceWith(b);try{a(h.progressIndicatorId+c).tooltip()}catch(a){require(["core/log"],function(b){b.debug(a)})}});b.render("format_tiles/progress",k(0,j,i.attr(g.numberOutOf),!0)).done(function(b){a("#tileprogress-0").replaceWith(b).fadeOut(0).animate({opacity:1},500)})},m=function(b){var d=b.attr(g.cmid),f=a("#completionstate_"+d),k={id:d,completionstate:parseInt(f.attr("value")),fromajax:1,sesskey:c.sesskey};try{b.tooltip("hide")}catch(a){require(["core/log"],function(b){b.debug(a)})}var m=c.wwwroot+"/course/togglecompletion.php";a.post(m,k,function(c,k){if("success"===k&&"OK"===c){var m,n=a(".completion_img_"+d);if("1"===f.attr("value")){a("#completion_dynamic_change").attr("value",0);f.attr("value",0);m=1;n.addClass(i.completionYes).removeClass(i.completionNo);a(".complete-y-"+d).fadeIn(200).fadeOut(1e3)}else{a("#completion_dynamic_change").attr("value",1);f.attr("value",1);m=-1;a(".complete-n-"+d).fadeIn(200).fadeOut(1e3);n.addClass(i.completionNo).removeClass(i.completionYes)}if(!f.closest(h.activity).is(j.map(function(a){return"."+a}).join(","))){l(b.attr(g.section),a(h.progressIndicatorId+b.attr(g.section)),m);require(["format_tiles/browser_storage"],function(a){a.storeCourseContent(e,b.attr("data-section"),"")})}}}).fail(function(){throw new Error("Failed to register completion change with server")})},n=function markAsAutoCompleteInUI(b){var c=b.closest(h.section).attr("data-section");if(b.hasClass("completeonview")){var d=b.find(".completion-icon"),g=d.closest(".completioncheckbox");if("0"===g.attr("data-ismanual")&&"0"===g.attr("data-completionstate")){d.addClass(i.completionYes).removeClass(i.completionNo);g.attr("data-completionstate",1);g.attr("data-original-title",f.completeauto);try{g.tooltip()}catch(a){require(["core/log"],function(b){b.debug(a)})}l(c,a(h.progressIndicatorId+c),1)}}require(["format_tiles/browser_storage"],function(a){a.storeCourseContent(e,c,"")})},o=function updateTileInformation(c){if(c===void 0){c=a(h.tile).not(h.spacer).map(function(b,c){return parseInt(a(c).attr("data-section"))}).toArray()}d.call([{methodname:"format_tiles_get_section_information",args:{courseid:e,sectionnums:c}}]).forEach(function(c){c.then(function(c){c.sections.forEach(function(c){var d=a(h.tileId+c.sectionnum);if(c.isavailable&&d.hasClass("tile-restricted")){d.removeClass("tile-restricted")}else if(!c.isavailable){d.addClass("tile-restricted")}if(c.isclickable&&!d.hasClass("tile-clickable")){d.addClass("tile-clickable")}else if(!c.isclickable&&d.hasClass("tile-clickable")){d.removeClass("tile-clickable")}var e=a(h.progressIndicatorId+c.sectionnum);if(e.attr("data-numcomplete")!==void 0&&e.attr("data-numcomplete")!==c.numcomplete.toString()){b.render("format_tiles/progress",k(c.sectionnum,c.numcomplete,c.numoutof,e.hasClass("percent"))).done(function(b){e.replaceWith(b);try{a(h.progressIndicatorId+c.sectionnum).tooltip()}catch(a){require(["core/log"],function(b){b.debug(a)})}})}var f=d.find(h.availabilityinfo);if(0<f.length&&c.isavailable&&!c.availabilitymessage){f.fadeOut()}else if(!c.isavailable&&c.availabilitymessage){if(0<f.length){f.html="NEW"+c.availabilitymessage;f.fadeIn()}else{b.render("format_tiles/availability_info",{availabilitymessage:c.availabilitymessage,visible:!0}).done(function(b){e.replaceWith(b);try{a(h.progressIndicatorId+c.sectionnum).tooltip()}catch(a){require(["core/log"],function(b){b.debug(a)})}})}}})}).catch(function(a){require(["core/log"],function(b){b.debug("Failed to get section information to check completion status of section");b.debug(a)})})})};return{init:function init(b,c,d){e=b;a(document).ready(function(){j=JSON.parse(d);f.completeauto=c;a("body").on("click",h.togglecompletion,function(b){b.preventDefault();m(a(b.currentTarget))});var b=a("#page-content");if(0===b.length){b=a("#region-main")}b.on("click",h.launchModuleModal+", "+h.launchResourceModal,function(b){var c=a(b.currentTarget).closest(h.activity);if(c.hasClass("completeonview")){n(c)}});a(h.pageContent).on("click",h.completeonevent+", "+h.completeonview,function(b){var c=a(b.currentTarget).closest(h.section).attr("data-section");require(["format_tiles/browser_storage"],function(a){a.storeCourseContent(e,c,"")})})})},markAsAutoCompleteInUI:function markAsAutoCompleteInUI(a,b){e=a;n(b)},updateTileInformation:function updateTileInformation(a){try{o(a)}catch(a){require(["core/log"],function(b){b.debug(a)})}}}});
//# sourceMappingURL=completion.min.js.map
